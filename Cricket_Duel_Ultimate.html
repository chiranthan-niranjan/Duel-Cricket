<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Cricket Duel By Chiranthan Niranjan </title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Cricket Duel By Chiranthan Niranjan">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#07122a">
<meta name="description" content="ICC T20 Cricket ‚Äî Auto Matchmaking, Invite Friends & AI opponent">
<script>
(function(){
  var m={name:"ICC T20 Cricket Duel",short_name:"Cricket Duel",start_url:".",display:"standalone",orientation:"portrait",background_color:"#07122a",theme_color:"#c9a22a",icons:[{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%2307122a'/%3E%3Ccircle cx='50' cy='50' r='30' fill='%23c9a22a'/%3E%3Ccircle cx='50' cy='50' r='18' fill='%23cc1111'/%3E%3C/svg%3E",sizes:"any",type:"image/svg+xml"}]};
  var l=document.createElement('link');l.rel='manifest';
  l.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(m));
  document.head.appendChild(l);
})();
</script>
<link href="https://fonts.googleapis.com/css2?family=Anton&family=Barlow:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<style>
:root{
  --navy:#07122a;--gold:#c9a22a;--gold2:#f0c84a;
  --red:#e63946;--grn:#2dc653;--blu:#4ea8de;
  --txt:#eef2ff;--mut:#7a90b8;--bdr:rgba(255,255,255,0.09);
  --F:'Anton',sans-serif;--B:'Barlow',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{min-height:100vh;width:100%;overscroll-behavior:none;}
body{font-family:var(--B);background:var(--navy);color:var(--txt);overflow-x:hidden;}
canvas{position:fixed;inset:0;pointer-events:none;}
#bgC{z-index:0;}#fxC{z-index:1;}
#app{position:relative;z-index:2;min-height:100vh;}

.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;padding-bottom:20px;}
.screen.active{display:flex;}

.topbar{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;padding:14px 20px;border-bottom:2px solid var(--gold);background:linear-gradient(180deg,rgba(0,0,0,.92),rgba(0,0,0,.4));flex-shrink:0;margin-bottom:20px;}
.topbar-logo{font-family:var(--F);font-size:1.5rem;letter-spacing:4px;color:var(--gold);text-shadow:0 0 20px rgba(201,162,42,.5);}
.topbar-sub{font-size:.58rem;letter-spacing:3px;color:var(--mut);}

.card{background:rgba(255,255,255,.03);border:1px solid rgba(201,162,42,.25);border-radius:16px;padding:24px 20px;width:calc(100% - 28px);max-width:460px;backdrop-filter:blur(18px);box-shadow:0 20px 50px rgba(0,0,0,.6);}
.card-title{font-family:var(--F);font-size:.95rem;letter-spacing:3px;color:var(--gold);margin-bottom:16px;}

.inp{width:100%;padding:12px 14px;margin-bottom:12px;background:rgba(255,255,255,.05);border:1px solid var(--bdr);border-radius:9px;color:var(--txt);font-family:var(--B);font-size:1rem;outline:none;transition:border-color .2s;}
.inp:focus{border-color:var(--gold);}
.inp::placeholder{color:var(--mut);}

.oc-row{display:flex;gap:7px;margin-bottom:16px;flex-wrap:wrap;}
.oc{padding:7px 14px;border:1px solid var(--bdr);border-radius:8px;background:rgba(255,255,255,.04);color:var(--mut);font-family:var(--F);font-size:1rem;cursor:pointer;transition:all .15s;}
.oc.sel{background:rgba(201,162,42,.15);border-color:var(--gold);color:var(--gold);}

.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(74px,1fr));gap:6px;margin-bottom:16px;}
.cc{background:rgba(255,255,255,.03);border:2px solid rgba(255,255,255,.07);border-radius:10px;padding:8px 5px;text-align:center;cursor:pointer;transition:all .15s;}
.cc:active{transform:scale(.96);}
.cc.sel{border-color:var(--gold);background:rgba(201,162,42,.1);}
.cc-f{font-size:1.6rem;display:block;margin-bottom:3px;}
.cc-n{font-size:.58rem;font-weight:700;color:var(--mut);}
.cc.sel .cc-n{color:var(--gold);}

.btn{width:100%;padding:15px;border:none;border-radius:12px;font-family:var(--F);font-size:1.4rem;letter-spacing:2px;cursor:pointer;transition:all .15s;margin-top:6px;}
.btn:active{transform:scale(.97);}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;box-shadow:0 6px 22px rgba(201,162,42,.4);}
.btn-blu{background:linear-gradient(135deg,#1a5a9a,var(--blu));color:#fff;}
.btn-grn{background:linear-gradient(135deg,#1a9940,var(--grn));color:#fff;}
.btn-ghost{background:rgba(255,255,255,.05);border:1px solid var(--bdr);color:var(--mut);font-size:1rem;}
.btn:disabled{opacity:.3;cursor:not-allowed;}

.status{padding:10px 14px;border-radius:8px;font-size:.78rem;letter-spacing:1px;margin-top:10px;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;line-height:1.5;}
.status.wait{background:rgba(201,162,42,.08);border:1px solid rgba(201,162,42,.25);color:var(--gold);}
.status.ok{background:rgba(45,198,83,.1);border:1px solid rgba(45,198,83,.3);color:var(--grn);}
.status.err{background:rgba(230,57,70,.1);border:1px solid rgba(230,57,70,.3);color:var(--red);}
.status.info{background:rgba(78,168,222,.08);border:1px solid rgba(78,168,222,.25);color:var(--blu);}
.dot{width:7px;height:7px;border-radius:50%;background:currentColor;animation:dp 1.1s infinite;flex-shrink:0;}
@keyframes dp{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.35;transform:scale(1.6);}}

/* MODE TABS */
.mode-tabs{display:flex;gap:0;width:calc(100% - 28px);max-width:460px;border-radius:12px;overflow:hidden;border:1px solid rgba(201,162,42,.3);margin-bottom:12px;}
.mode-tab{flex:1;padding:12px;border:none;background:rgba(255,255,255,.03);color:var(--mut);font-family:var(--F);font-size:.85rem;letter-spacing:2px;cursor:pointer;transition:all .2s;text-align:center;}
.mode-tab.active{background:rgba(201,162,42,.15);color:var(--gold);}
.mode-tab:first-child{border-right:1px solid rgba(201,162,42,.25);}

/* SHARE BOX */
.share-box{margin-top:14px;background:rgba(0,0,0,.5);border:1px dashed rgba(201,162,42,.4);border-radius:12px;padding:16px;text-align:center;}
.share-label{font-size:.62rem;letter-spacing:3px;color:var(--mut);margin-bottom:10px;}
.share-link{font-family:monospace;font-size:.72rem;color:var(--gold);word-break:break-all;line-height:1.6;margin-bottom:12px;background:rgba(255,255,255,.03);padding:8px;border-radius:6px;cursor:pointer;}
.share-btns{display:flex;gap:8px;}
.share-btn{flex:1;padding:10px;border:none;border-radius:9px;font-family:var(--F);font-size:.85rem;letter-spacing:1px;cursor:pointer;transition:all .15s;}
.share-btn:active{transform:scale(.97);}
.share-btn.wa{background:#25d366;color:#fff;}
.share-btn.copy{background:rgba(201,162,42,.15);border:1px solid rgba(201,162,42,.4);color:var(--gold);}

/* TOSS */
.toss-flags{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:24px;}
.tf{text-align:center;}
.tf-f{font-size:2.8rem;display:block;margin-bottom:5px;}
.tf-n{font-family:var(--F);font-size:.85rem;letter-spacing:2px;}
.toss-vs{font-family:var(--F);font-size:1.6rem;color:rgba(255,255,255,.12);}
.coin{width:110px;height:110px;margin:0 auto 20px;border-radius:50%;background:radial-gradient(circle at 36% 30%,#ffe680,#c9a22a 40%,#7a6000);border:4px solid #a07800;display:flex;align-items:center;justify-content:center;font-size:2.6rem;cursor:pointer;user-select:none;box-shadow:0 8px 28px rgba(201,162,42,.5),inset 0 3px 6px rgba(255,255,255,.25);transition:transform .1s;}
.coin:active{transform:scale(.94);}
.coin.flip{animation:cflip 1.4s ease-in-out forwards;}
@keyframes cflip{0%{transform:rotateX(0);}30%{transform:rotateX(540deg) scale(.7);}65%{transform:rotateX(1080deg) scale(1.1);}100%{transform:rotateX(1440deg);}}
.side-btns{display:flex;gap:10px;justify-content:center;margin-bottom:14px;}
.side-btn{padding:10px 24px;border:2px solid var(--bdr);background:transparent;color:var(--txt);border-radius:10px;font-family:var(--F);font-size:1rem;letter-spacing:1px;cursor:pointer;transition:all .15s;}
.side-btn:active{transform:scale(.96);}
.side-btn.ch{border-color:var(--gold);color:var(--gold);background:rgba(201,162,42,.1);}
.toss-res{font-family:var(--F);font-size:1.5rem;letter-spacing:2px;min-height:44px;margin:8px 0;text-align:center;line-height:1.3;}
.bb-btns{display:flex;gap:10px;justify-content:center;margin-top:12px;}
.bb-btn{padding:12px 24px;border:none;border-radius:10px;font-family:var(--F);font-size:1.1rem;letter-spacing:1px;cursor:pointer;transition:all .15s;}
.bb-btn:active{transform:scale(.96);}
.bb-btn.bat{background:linear-gradient(135deg,var(--grn),#1a9940);color:#fff;}
.bb-btn.bowl{background:linear-gradient(135deg,var(--blu),#2a78ae);color:#fff;}

/* GAME */
#gameScreen{padding:0;justify-content:flex-start;overflow-y:auto;}
.scorebar{width:100%;background:linear-gradient(180deg,rgba(0,0,0,.95),rgba(7,18,42,.98));border-bottom:2px solid var(--gold);padding:9px 14px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px;position:sticky;top:0;z-index:20;flex-shrink:0;}
.sb-t{display:flex;align-items:center;gap:8px;}
.sb-t.r{flex-direction:row-reverse;}
.sb-flag{font-size:1.8rem;}
.sb-nm{font-family:var(--F);font-size:.65rem;letter-spacing:2px;color:var(--mut);}
.sb-sc{font-family:var(--F);font-size:1.75rem;line-height:1.1;}
.sb-sc.bat{color:var(--gold);}
.sb-sc.fld{color:var(--mut);}
.sb-ov{font-size:.6rem;color:var(--mut);}
.sb-mid{text-align:center;}
.sb-inn{font-family:var(--F);font-size:.55rem;letter-spacing:2px;color:var(--gold);background:rgba(201,162,42,.1);border:1px solid rgba(201,162,42,.3);padding:2px 7px;border-radius:10px;display:inline-block;margin-bottom:2px;}
.sb-ovc{font-family:var(--F);font-size:1.1rem;}
.sb-tgt{font-size:.58rem;color:var(--mut);}

.game-main{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 12px 20px;gap:8px;width:100%;overflow-y:auto;-webkit-overflow-scrolling:touch;}

.crowd{width:100%;max-width:640px;height:22px;border-radius:10px 10px 0 0;overflow:hidden;background:linear-gradient(90deg,#1a2a4a 0%,#2a1038 25%,#1a3a1a 50%,#3a2006 75%,#1a2a4a 100%);position:relative;box-shadow:inset 0 -4px 12px rgba(0,0,0,.4);}
.crowd::before{content:'üôÜüôãüôÜüëêüôãüôÜüôãüëêüôÜüôãüôÜüëêüôãüôÜüôÜüôãüëêüôãüôÜüôã';position:absolute;inset:0;font-size:11px;display:flex;align-items:center;padding:2px 6px;white-space:nowrap;overflow:hidden;animation:cw 3s linear infinite;opacity:.5;}
@keyframes cw{0%{transform:translateX(0);}100%{transform:translateX(-120px);}}
.crowd::after{content:'';position:absolute;bottom:0;left:0;right:0;height:6px;background:linear-gradient(0deg,rgba(0,80,0,.4),transparent);}

.field{width:100%;max-width:640px;background:radial-gradient(ellipse 95% 75% at 50% 92%,#22751e,#0d4a0c 60%,#063008);border-radius:0 0 190px 190px;border:1px solid rgba(255,255,255,.06);border-top:none;display:flex;justify-content:space-between;align-items:flex-end;padding:10px 6px 18px;position:relative;overflow:hidden;min-height:170px;}
.field::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(175deg,transparent 0px,transparent 20px,rgba(255,255,255,.015) 20px,rgba(255,255,255,.015) 40px);}
.field::after{content:'';position:absolute;width:84%;height:70%;border:2px solid rgba(255,255,255,.08);border-radius:50%;left:50%;top:36%;transform:translate(-50%,-50%);box-shadow:0 0 20px rgba(255,255,255,.03);}

.char{display:flex;flex-direction:column;align-items:center;gap:4px;z-index:3;}
.char.left{align-items:flex-end;padding-right:4px;}
.char.right{align-items:flex-start;padding-left:4px;}
.char-svg{width:62px;height:118px;filter:drop-shadow(0 8px 16px rgba(0,0,0,.8));}
.char-svg svg{width:100%;height:100%;}
.char-lbl{text-align:center;}
.char-flag{font-size:1.1rem;}
.char-name{font-family:var(--F);font-size:.62rem;letter-spacing:1px;}
.char-role{font-size:.56rem;letter-spacing:1px;}
.char-role.bat{color:var(--gold);}
.char-role.bowl{color:var(--blu);}

.pitch-c{display:flex;flex-direction:column;align-items:center;justify-content:flex-end;z-index:3;}
.pitch{width:54px;height:150px;position:relative;background:linear-gradient(180deg,#3a7a2a 0%,#2a5a1a 13%,#d4b870 13%,#c09a50 50%,#b08040 100%);border-radius:27px;overflow:visible;box-shadow:0 8px 28px rgba(0,0,0,.65),0 0 0 1px rgba(255,255,255,.06);}
.pitch::before{content:'';position:absolute;inset:13% 15% 0;background:repeating-linear-gradient(0deg,transparent 0,transparent 12px,rgba(0,0,0,.07) 12px,rgba(0,0,0,.07) 14px);}
.pc{position:absolute;left:50%;transform:translateX(-50%);width:88%;height:2px;background:rgba(255,255,255,.55);border-radius:1px;box-shadow:0 0 4px rgba(255,255,255,.3);}
.pc.t{top:24%}.pc.b{bottom:12%}
.stumps{position:absolute;left:50%;transform:translateX(-50%);display:flex;gap:4px;}
.stumps.ts{top:12%}.stumps.bs{bottom:4%}
.stump{width:4px;height:26px;background:linear-gradient(180deg,#fff8c0,#ffe066,#c89800);border-radius:2px;box-shadow:0 0 8px rgba(255,220,0,.5),0 0 2px rgba(255,220,0,.8);position:relative;}
.bail{position:absolute;top:-3px;left:-3px;width:calc(100% + 6px);height:3px;background:linear-gradient(90deg,#ffe066,#fff8c0,#ffe066);border-radius:2px;box-shadow:0 0 5px rgba(255,220,0,.6);}
.ball{position:absolute;width:22px;height:22px;border-radius:50%;background:radial-gradient(circle at 32% 28%,#ff9a9a,#cc0000 45%,#880000);box-shadow:3px 4px 10px rgba(0,0,0,.7),inset -2px -2px 4px rgba(0,0,0,.3);left:50%;transform:translateX(-50%);top:16%;transition:top .34s cubic-bezier(.25,.8,.25,1);z-index:5;}
.ball::after{content:'';position:absolute;top:9px;left:3px;right:3px;height:2px;border-top:2px dashed rgba(255,255,255,.22);border-radius:50%;}
.ball.flying{box-shadow:3px 4px 14px rgba(0,0,0,.7),0 0 20px rgba(220,60,60,.55);}

.over-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center;}
.olbl{font-size:.58rem;letter-spacing:2px;color:var(--mut);margin-right:3px;}
.bc{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--F);font-size:.82rem;border:2px solid;}
.bc.dot{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.1);color:var(--mut);}
.bc.r1,.bc.r2,.bc.r3{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.18);color:var(--txt);}
.bc.r4{background:rgba(45,198,83,.16);border-color:var(--grn);color:var(--grn);}
.bc.r6{background:rgba(201,162,42,.18);border-color:var(--gold);color:var(--gold);}
.bc.wk{background:rgba(230,57,70,.16);border-color:var(--red);color:var(--red);}
.bc.em{background:transparent;border-color:rgba(255,255,255,.07);border-style:dashed;}

.role-badge{padding:9px 18px;border-radius:10px;font-family:var(--F);font-size:.92rem;letter-spacing:2px;text-align:center;}
.role-badge.bat{background:rgba(201,162,42,.12);border:1px solid rgba(201,162,42,.35);color:var(--gold);}
.role-badge.bowl{background:rgba(78,168,222,.1);border:1px solid rgba(78,168,222,.35);color:var(--blu);}
.role-badge.wait{background:rgba(255,255,255,.04);border:1px solid var(--bdr);color:var(--mut);}

.pbar{width:100%;max-width:480px;text-align:center;}
.pbar-lbl{font-family:var(--F);font-size:.65rem;letter-spacing:3px;color:var(--mut);margin-bottom:7px;}
.pbar-track{position:relative;height:48px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.09);border-radius:24px;overflow:hidden;box-shadow:inset 0 2px 8px rgba(0,0,0,.4);}
.pbar-fill{height:100%;width:0%;background:linear-gradient(90deg,#3ecf6c 0%,#7ade8a 22%,#f0c040 50%,#ff8c00 70%,#e63946 85%,#ff004c 100%);border-radius:24px;position:relative;}
.pbar-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:4px;background:#fff;box-shadow:0 0 12px 3px #fff;border-radius:3px;}
.pbar-zones{position:absolute;inset:0;display:flex;pointer-events:none;}
.pz{height:100%;display:flex;align-items:center;justify-content:center;font-family:var(--F);font-size:.7rem;border-right:1px solid rgba(255,255,255,.07);color:rgba(255,255,255,.25);}
.pz:last-child{border-right:none;}
.hit-btn{margin-top:10px;padding:14px 44px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-family:var(--F);font-size:1.4rem;letter-spacing:2px;cursor:pointer;box-shadow:0 5px 18px rgba(201,162,42,.4);}
.hit-btn:active{transform:scale(.96);}
.hit-btn:disabled{opacity:.28;cursor:not-allowed;}
.bowl-btn{margin-top:10px;padding:14px 44px;border:none;border-radius:12px;background:linear-gradient(135deg,#1a6aae,var(--blu));color:#fff;font-family:var(--F);font-size:1.4rem;letter-spacing:2px;cursor:pointer;box-shadow:0 5px 18px rgba(78,168,222,.4);}
.bowl-btn:active{transform:scale(.96);}
.bowl-btn:disabled{opacity:.28;cursor:not-allowed;}

.sbar{width:100%;max-width:480px;text-align:center;margin-bottom:4px;}
.sbar-lbl{font-family:var(--F);font-size:.65rem;letter-spacing:3px;color:var(--mut);margin-bottom:7px;}
.sbar-track{position:relative;height:48px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.09);border-radius:24px;overflow:hidden;box-shadow:inset 0 2px 8px rgba(0,0,0,.4);}
.sbar-fill{height:100%;width:0%;background:linear-gradient(90deg,#4ea8de 0%,#7ad8ff 20%,#2dc653 45%,#f0c040 68%,#ff8c00 82%,#e63946 100%);border-radius:24px;position:relative;}
.sbar-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:4px;background:#fff;box-shadow:0 0 12px 3px #fff;border-radius:3px;}
.sbar-zones{position:absolute;inset:0;display:flex;pointer-events:none;}
.sz{height:100%;display:flex;align-items:center;justify-content:center;font-family:var(--F);font-size:.7rem;border-right:1px solid rgba(255,255,255,.07);color:rgba(255,255,255,.25);}
.sz:last-child{border-right:none;}
.speed-hint{font-size:.62rem;color:var(--mut);margin-top:5px;letter-spacing:1px;}

.bowl-type-row{display:flex;gap:10px;justify-content:center;margin-bottom:12px;width:100%;}
.bowl-type-btn{flex:1;max-width:180px;padding:16px 10px;border:2px solid var(--bdr);border-radius:16px;background:rgba(255,255,255,.06);color:var(--txt);font-family:var(--F);font-size:1rem;letter-spacing:1px;cursor:pointer;transition:all .18s;text-align:center;animation:btnPulse 2s ease-in-out infinite;}
@keyframes btnPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,.1);}50%{box-shadow:0 0 0 6px rgba(255,255,255,.04);}}
.bowl-type-btn:active{transform:scale(.96);}
.bowl-type-btn.sel-fast{border-color:#ff6b35;color:#ff6b35;background:rgba(255,107,53,.12);box-shadow:0 0 20px rgba(255,107,53,.3);animation:none;}
.bowl-type-btn.sel-spin{border-color:#9b59b6;color:#c39bd3;background:rgba(155,89,182,.12);box-shadow:0 0 20px rgba(155,89,182,.3);animation:none;}
.bowl-type-icon{font-size:2rem;display:block;margin-bottom:5px;}
.bowl-type-sub{font-size:.55rem;letter-spacing:2px;opacity:.65;display:block;margin-top:3px;}

.pbar-fill.spin-mode{background:linear-gradient(90deg,#9b59b6 0%,#c39bd3 25%,#6c3483 45%,#4a235a 60%,#cc0000 70%,#ff0000 100%);}
.sbar-fill.fast-mode{background:linear-gradient(90deg,#4ea8de 0%,#2dc653 30%,#f0c040 55%,#ff6b35 75%,#e63946 90%,#ff004c 100%);}
.sbar-fill.spin-mode{background:linear-gradient(90deg,#9b59b6 0%,#7d3c98 35%,#5b2c6f 65%,#4a235a 100%);}

.bowl-mode-badge{display:inline-block;padding:3px 10px;border-radius:8px;font-family:var(--F);font-size:.6rem;letter-spacing:2px;margin-left:6px;}
.bowl-mode-badge.fast{background:rgba(255,107,53,.15);border:1px solid rgba(255,107,53,.4);color:#ff6b35;}
.bowl-mode-badge.spin{background:rgba(155,89,182,.15);border:1px solid rgba(155,89,182,.4);color:#c39bd3;}

@keyframes spinBall{0%{transform:translateX(-50%) rotate(0deg);}100%{transform:translateX(-50%) rotate(360deg);}}
.ball.spin-delivery{animation:spinBall .6s linear infinite;box-shadow:3px 4px 10px rgba(0,0,0,.7),0 0 18px rgba(155,89,182,.7);}
.ball.fast-delivery{box-shadow:3px 4px 14px rgba(0,0,0,.7),0 0 22px rgba(255,107,53,.7);}

#pbarZonesSpin{display:none;}
#pbarZonesFast{display:flex;}
.wait-pulse{text-align:center;padding:20px 0;}
.wait-icon{font-size:2.2rem;animation:wobble 1.2s ease-in-out infinite;display:inline-block;}
@keyframes wobble{0%,100%{transform:rotate(-8deg);}50%{transform:rotate(8deg);}}
.wait-txt{font-family:var(--F);font-size:.8rem;letter-spacing:3px;color:var(--mut);margin-top:8px;}

#breakScreen{justify-content:center;padding:20px;}
.brk-flags{font-size:2.5rem;display:flex;gap:16px;justify-content:center;margin-bottom:12px;}
.brk-title{font-family:var(--F);font-size:2rem;letter-spacing:4px;color:var(--gold);text-align:center;margin-bottom:5px;}
.brk-sub{font-size:.8rem;color:var(--mut);text-align:center;margin-bottom:18px;letter-spacing:1px;}
.tgt-box{background:rgba(201,162,42,.08);border:1px solid rgba(201,162,42,.35);border-radius:14px;padding:20px;margin:0 0 18px;text-align:center;}
.tgt-n{font-family:var(--F);font-size:4rem;color:var(--gold);line-height:1;}
.tgt-s{font-size:.65rem;letter-spacing:3px;color:var(--mut);margin-top:4px;}
.chase-ln{font-size:.85rem;color:var(--txt);text-align:center;margin-bottom:20px;}

#scorecardScreen{justify-content:center;padding:20px;}
.sc-trophy{font-size:3.2rem;display:block;text-align:center;animation:tp 1.4s ease-in-out infinite;}
@keyframes tp{0%,100%{transform:scale(1) rotate(-4deg);}50%{transform:scale(1.1) rotate(4deg);}}
.sc-wf{font-size:2.6rem;display:block;text-align:center;margin-top:6px;}
.sc-wn{font-family:var(--F);font-size:2rem;letter-spacing:3px;color:var(--gold);text-align:center;}
.sc-r{color:var(--mut);letter-spacing:2px;font-size:.78rem;text-align:center;margin-bottom:22px;}
.sc-it{font-family:var(--F);font-size:.72rem;letter-spacing:2px;color:var(--gold);margin:14px 0 7px;padding-bottom:5px;border-bottom:1px solid rgba(201,162,42,.25);}
table.sc-t{width:100%;border-collapse:collapse;}
.sc-t th{font-size:.6rem;letter-spacing:1px;color:var(--mut);padding:5px 4px;text-align:center;}
.sc-t th:first-child{text-align:left;}
.sc-t td{padding:7px 4px;font-size:.8rem;border-bottom:1px solid rgba(255,255,255,.05);text-align:center;}
.sc-t td:first-child{text-align:left;font-weight:700;}
.sc-t td.hi{color:var(--gold);font-family:var(--F);font-size:.95rem;}

.btn-rematch{background:linear-gradient(135deg,#1a9940,var(--grn));color:#fff;box-shadow:0 6px 22px rgba(45,198,83,.35);font-size:1.1rem;letter-spacing:2px;}
.btn-rematch:active{transform:scale(.97);}
.search-dot{width:12px;height:12px;border-radius:50%;background:var(--gold);animation:sDot 1s ease-in-out infinite;}
@keyframes sDot{0%,100%{transform:scale(.5);opacity:.35;}50%{transform:scale(1);opacity:1;}}

/* splash */
#splash{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .12s;}
#splash.on{opacity:1;}
.sp-in{transform:scale(0);transition:transform .22s cubic-bezier(.34,1.56,.64,1);text-align:center;}
#splash.on .sp-in{transform:scale(1);}
.sp-r{font-family:var(--F);font-size:6.5rem;line-height:1;letter-spacing:4px;text-shadow:0 0 70px currentColor,0 0 35px currentColor;}
.sp-m{font-family:var(--F);font-size:1.1rem;letter-spacing:5px;opacity:.75;margin-top:3px;}

#connDot{position:fixed;top:10px;right:12px;z-index:50;width:9px;height:9px;border-radius:50%;background:#666;box-shadow:0 0 0 2px rgba(0,0,0,.4);}
#connDot.connected{background:var(--grn);box-shadow:0 0 8px rgba(45,198,83,.6);}
#connDot.connecting{background:var(--gold);animation:dp 1s infinite;}

#appSplash{position:fixed;inset:0;z-index:500;background:linear-gradient(160deg,#010810 0%,#07122a 55%,#0a1f10 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;transition:opacity .5s ease,transform .5s ease;}
#appSplash.gone{opacity:0;transform:scale(1.04);pointer-events:none;}
.as-icon{width:100px;height:100px;border-radius:24px;background:radial-gradient(circle at 35% 30%,#ffe680,#c9a22a 45%,#8a6800);box-shadow:0 12px 40px rgba(201,162,42,.45);display:flex;align-items:center;justify-content:center;font-size:3.2rem;animation:asIconPop .7s cubic-bezier(.34,1.56,.64,1) .15s both;}
@keyframes asIconPop{from{transform:scale(0) rotate(-15deg);}to{transform:scale(1) rotate(0);}}
.as-title{font-family:var(--F);font-size:2rem;letter-spacing:6px;color:var(--gold);text-shadow:0 0 30px rgba(201,162,42,.4);animation:asFadeUp .5s ease .5s both;}
.as-sub{font-size:.62rem;letter-spacing:4px;color:var(--mut);animation:asFadeUp .5s ease .65s both;}
.as-loader{width:100px;height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin-top:6px;animation:asFadeUp .4s ease .8s both;}
.as-loader-bar{height:100%;width:0;background:linear-gradient(90deg,var(--gold),var(--gold2));border-radius:2px;animation:asLoad 1.2s ease .9s forwards;}
@keyframes asLoad{to{width:100%;}}
@keyframes asFadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:none;}}

#installBanner{position:fixed;bottom:0;left:0;right:0;z-index:400;padding:14px 16px 20px;background:linear-gradient(0deg,rgba(0,0,0,.98),rgba(7,18,42,.96));border-top:1px solid rgba(201,162,42,.3);display:flex;align-items:center;gap:12px;transform:translateY(110%);transition:transform .35s cubic-bezier(.25,.8,.25,1);box-shadow:0 -10px 40px rgba(0,0,0,.6);}
#installBanner.visible{transform:translateY(0);}
.ib-icon{font-size:2.2rem;flex-shrink:0;}
.ib-text{flex:1;min-width:0;}
.ib-title{font-family:var(--F);font-size:.9rem;letter-spacing:2px;color:var(--gold);margin-bottom:3px;}
.ib-sub{font-size:.68rem;color:var(--mut);line-height:1.4;}
.ib-btns{display:flex;flex-direction:column;gap:6px;flex-shrink:0;}
.ib-btn{padding:9px 18px;border:none;border-radius:9px;font-family:var(--F);font-size:.75rem;letter-spacing:1px;cursor:pointer;white-space:nowrap;}
.ib-btn.primary{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;}
.ib-btn.secondary{background:rgba(255,255,255,.07);border:1px solid var(--bdr);color:var(--mut);}

/* PROFILE BADGE */
.prof-badge{display:flex;align-items:center;gap:12px;background:rgba(201,162,42,.07);border:1px solid rgba(201,162,42,.25);border-radius:14px;padding:14px 16px;margin-bottom:12px;width:calc(100% - 28px);max-width:460px;}
.prof-badge-flag{font-size:2.2rem;flex-shrink:0;}
.prof-badge-info{flex:1;min-width:0;}
.prof-badge-name{font-family:var(--F);font-size:1.1rem;letter-spacing:2px;color:var(--gold);margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.prof-badge-country{font-size:.65rem;letter-spacing:2px;color:var(--mut);}
.prof-edit-btn{padding:8px 14px;border:1px solid rgba(201,162,42,.35);border-radius:9px;background:rgba(201,162,42,.08);color:var(--gold);font-family:var(--F);font-size:.75rem;letter-spacing:1px;cursor:pointer;flex-shrink:0;transition:all .15s;}
.prof-edit-btn:active{transform:scale(.96);}

/* COUNTDOWN RING */
.countdown-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;margin:10px 0 14px;}
.countdown-ring{position:relative;width:90px;height:90px;}
.countdown-ring svg{transform:rotate(-90deg);}
.countdown-ring circle{fill:none;stroke-linecap:round;transition:stroke-dashoffset 1s linear;}
.cring-bg{stroke:rgba(255,255,255,.07);}
.cring-fg{stroke:var(--gold);}
.countdown-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--F);font-size:1.8rem;color:var(--gold);}
.countdown-label{font-size:.6rem;letter-spacing:3px;color:var(--mut);}
.ai-incoming{font-size:.72rem;color:var(--mut);text-align:center;line-height:1.6;margin-top:4px;}
.ai-incoming strong{color:var(--gold);}

.ai-pill{display:inline-block;padding:3px 10px;border-radius:20px;background:rgba(78,168,222,.12);border:1px solid rgba(78,168,222,.3);font-size:.6rem;letter-spacing:2px;color:var(--blu);margin-left:6px;vertical-align:middle;}
.diff-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.58rem;letter-spacing:1.5px;margin-left:5px;vertical-align:middle;}
.diff-easy{background:rgba(45,198,83,.15);border:1px solid rgba(45,198,83,.4);color:var(--grn);}
.diff-medium{background:rgba(240,200,64,.12);border:1px solid rgba(240,200,64,.4);color:#f0c840;}
.diff-hard{background:rgba(255,107,53,.15);border:1px solid rgba(255,107,53,.4);color:#ff6b35;}
.diff-vhard{background:rgba(230,57,70,.15);border:1px solid rgba(230,57,70,.4);color:var(--red);}
</style>
</head>
<body>

<div id="appSplash">
  <div class="as-icon">üèè</div>
  <div class="as-title">CRICKET DUEL</div>
  <div class="as-sub">ICC T20 ¬∑ ULTIMATE EDITION</div>
  <div class="as-loader"><div class="as-loader-bar"></div></div>
</div>

<div id="installBanner">
  <div class="ib-icon">üì≤</div>
  <div class="ib-text">
    <div class="ib-title">INSTALL APP</div>
    <div class="ib-sub">Add to home screen for the full experience</div>
  </div>
  <div class="ib-btns">
    <button class="ib-btn primary" onclick="doInstall()">INSTALL</button>
    <button class="ib-btn secondary" onclick="dismissBanner()">Later</button>
  </div>
</div>
<canvas id="bgC"></canvas>
<canvas id="fxC"></canvas>
<div id="connDot" title="Connection status"></div>
<div id="app">

<!-- PROFILE SETUP -->
<div id="profileScreen" class="screen">
  <div class="topbar">
    <span style="font-size:1.9rem;">üèè</span>
    <div><div class="topbar-logo">ICC T20 DUEL</div><div class="topbar-sub">CREATE YOUR PROFILE</div></div>
    <span style="font-size:1.9rem;">üèÜ</span>
  </div>
  <div class="card">
    <div class="card-title">üë§ YOUR IDENTITY</div>
    <input class="inp" id="profName" placeholder="Enter your name" maxlength="14" autocomplete="name">
    <div style="font-size:.62rem;letter-spacing:2px;color:var(--mut);margin-bottom:8px;">SELECT YOUR COUNTRY</div>
    <div class="cgrid" id="profGrid"></div>
    <button class="btn btn-gold" onclick="saveProfile()">‚úÖ SAVE &amp; PLAY ‚Üí</button>
    <div id="profStatus"></div>
  </div>
</div>

<!-- HOME -->
<div id="homeScreen" class="screen active">
  <div class="topbar">
    <span style="font-size:1.9rem;">üèÜ</span>
    <div><div class="topbar-logo">ICC T20 DUEL</div><div class="topbar-sub">ULTIMATE EDITION</div></div>
    <span style="font-size:1.9rem;">üèè</span>
  </div>
  <div id="onlineBar" style="width:100%;max-width:480px;display:flex;align-items:center;justify-content:center;gap:8px;padding:4px 0;">
    <span style="width:8px;height:8px;border-radius:50%;background:var(--grn);flex-shrink:0;box-shadow:0 0 8px var(--grn);animation:dp 1.2s infinite;display:inline-block;"></span>
    <span style="font-size:.65rem;letter-spacing:2px;color:var(--mut);" id="onlineTxt">CONNECTING TO SERVERS...</span>
  </div>
  <div class="prof-badge" id="profBadge" style="margin-top:8px;">
    <div class="prof-badge-flag" id="homeProfFlag">üè¥</div>
    <div class="prof-badge-info">
      <div class="prof-badge-name" id="homeProfName">‚Äî</div>
      <div class="prof-badge-country" id="homeProfCountry">SET UP YOUR PROFILE</div>
    </div>
    <button class="prof-edit-btn" onclick="goTo('profileScreen')">‚úèÔ∏è EDIT</button>
  </div>

  <!-- MODE TABS -->
  <div class="mode-tabs">
    <button class="mode-tab active" id="tabAuto" onclick="switchTab('auto')">üîç AUTO MATCH</button>
    <button class="mode-tab" id="tabInvite" onclick="switchTab('invite')">üì≤ INVITE FRIEND</button>
  </div>

  <!-- AUTO MATCH CARD -->
  <div class="card" id="autoMatchCard" style="margin-top:0;">
    <div class="card-title">‚öôÔ∏è MATCH SETTINGS</div>
    <div style="font-size:.62rem;letter-spacing:2px;color:var(--mut);margin-bottom:7px;">OVERS PER INNINGS</div>
    <div class="oc-row" id="overRow">
      <div class="oc" onclick="setOvers(2,this)">2</div>
      <div class="oc sel" onclick="setOvers(5,this)">5</div>
      <div class="oc" onclick="setOvers(10,this)">10</div>
      <div class="oc" onclick="setOvers(20,this)">20</div>
    </div>
    <button class="btn btn-gold" id="findBtn" onclick="findMatch()">üîç FIND MATCH</button>
    <div id="matchStatus"></div>
  </div>
  <div id="searchingCard" class="card" style="display:none;margin-top:10px;text-align:center;">
    <div style="font-size:2.4rem;animation:wobble 1s ease-in-out infinite;display:inline-block;">üîç</div>
    <div style="font-family:var(--F);font-size:1rem;letter-spacing:3px;color:var(--gold);margin:8px 0 3px;" id="searchTxt">SEARCHING FOR OPPONENT...</div>
    <div style="font-size:.68rem;color:var(--mut);margin-bottom:12px;" id="searchSub">Looking for available players</div>
    <div class="countdown-wrap">
      <div class="countdown-ring">
        <svg width="90" height="90" viewBox="0 0 90 90">
          <circle class="cring-bg" cx="45" cy="45" r="38" stroke-width="6"/>
          <circle class="cring-fg" id="cringFg" cx="45" cy="45" r="38" stroke-width="6" stroke-dasharray="238.76" stroke-dashoffset="0"/>
        </svg>
        <div class="countdown-num" id="countdownNum">30</div>
      </div>
      <div class="countdown-label">MAX WAIT TIME</div>
    </div>
    <div class="ai-incoming">No opponent found?<br><strong>ü§ñ Choose your AI country &amp; difficulty!</strong></div>
    <div style="display:flex;justify-content:center;gap:8px;margin:12px 0 4px;">
      <div class="search-dot"></div>
      <div class="search-dot" style="animation-delay:.2s"></div>
      <div class="search-dot" style="animation-delay:.4s"></div>
    </div>
    <button class="btn btn-ghost" onclick="cancelSearch()" style="margin-top:4px;">‚úï Cancel Search</button>
  </div>

  <!-- INVITE FRIEND CARD -->
  <div class="card" id="inviteCard" style="display:none;margin-top:0;">
    <div class="card-title">üì≤ PLAY WITH A FRIEND</div>
    <div style="color:var(--mut);font-size:.84rem;line-height:1.8;margin-bottom:18px;">
      <strong style="color:var(--gold);">HOST:</strong> Create a room ‚Üí share link via WhatsApp.<br>
      <strong style="color:var(--blu);">GUEST:</strong> Open the link ‚Üí join instantly.
    </div>
    <button class="btn btn-gold" onclick="goTo('inviteSetupScreen')">üèüÔ∏è HOST ‚Äî CREATE ROOM</button>
    <button class="btn btn-blu" style="margin-top:8px;" onclick="goToJoin()">üîó GUEST ‚Äî JOIN VIA CODE</button>
  </div>
</div>

<!-- INVITE: HOST SETUP -->
<div id="inviteSetupScreen" class="screen">
  <div class="topbar">
    <span style="font-size:1.9rem;">üè†</span>
    <div><div class="topbar-logo">CREATE ROOM</div><div class="topbar-sub">YOU ARE THE HOST</div></div>
  </div>
  <div class="card">
    <div class="card-title">üß¢ HOST DETAILS</div>
    <input class="inp" id="hostName" placeholder="Your name" maxlength="14">
    <div style="font-size:.62rem;letter-spacing:2px;color:var(--mut);margin-bottom:7px;">OVERS</div>
    <div class="oc-row" id="hostOcRow">
      <div class="oc" onclick="setHostOv(2,this)">2</div>
      <div class="oc sel" onclick="setHostOv(5,this)">5</div>
      <div class="oc" onclick="setHostOv(10,this)">10</div>
      <div class="oc" onclick="setHostOv(20,this)">20</div>
    </div>
    <div style="font-size:.62rem;letter-spacing:2px;color:var(--mut);margin-bottom:7px;">YOUR COUNTRY</div>
    <div class="cgrid" id="hostGrid"></div>
    <button class="btn btn-gold" onclick="createRoom()" id="createBtn">üîó CREATE &amp; GET SHARE LINK</button>
    <div id="hostStatus"></div>
    <div id="shareBox" style="display:none;">
      <div class="share-box">
        <div class="share-label">üì§ SHARE THIS LINK WITH YOUR OPPONENT</div>
        <div class="share-link" id="shareLink" onclick="copyLink()">Generating link...</div>
        <div class="share-btns">
          <button class="share-btn wa" onclick="shareWhatsApp()">üì≤ WhatsApp</button>
          <button class="share-btn copy" id="copyBtn" onclick="copyLink()">üìã Copy</button>
        </div>
      </div>
      <div class="status wait" id="waitingStatus" style="margin-top:12px;">
        <span class="dot"></span> Waiting for your opponent to join...
      </div>
    </div>
    <button class="btn btn-ghost" onclick="goTo('homeScreen')" style="margin-top:10px;">‚Üê Back</button>
  </div>
</div>

<!-- INVITE: GUEST JOIN -->
<div id="inviteJoinScreen" class="screen">
  <div class="topbar">
    <span style="font-size:1.9rem;">üîó</span>
    <div><div class="topbar-logo">JOIN ROOM</div><div class="topbar-sub">GUEST PLAYER</div></div>
  </div>
  <div class="card">
    <div class="card-title">üß¢ GUEST DETAILS</div>
    <input class="inp" id="guestName" placeholder="Your name" maxlength="14">
    <div style="font-size:.62rem;letter-spacing:2px;color:var(--mut);margin-bottom:7px;">YOUR COUNTRY</div>
    <div class="cgrid" id="guestGrid"></div>
    <div style="font-size:.62rem;letter-spacing:2px;color:var(--mut);margin:12px 0 7px;">ROOM CODE (from host's link)</div>
    <input class="inp" id="guestCode" placeholder="Paste code here" style="font-family:monospace;letter-spacing:2px;font-size:.9rem;" oninput="this.value=this.value.replace(/[^a-z0-9-]/gi,'')">
    <button class="btn btn-grn" onclick="joinRoom()">‚ö° JOIN MATCH</button>
    <div id="joinStatus"></div>
    <button class="btn btn-ghost" onclick="goTo('homeScreen')" style="margin-top:10px;">‚Üê Back</button>
  </div>
</div>

<!-- TOSS -->
<div id="tossScreen" class="screen">
  <div class="topbar">
    <span style="font-size:1.9rem;">ü™ô</span>
    <div><div class="topbar-logo">TOSS TIME</div><div class="topbar-sub" id="tossSubLbl">P1 CALLS</div></div>
  </div>
  <div class="card">
    <div class="toss-flags">
      <div class="tf"><span class="tf-f" id="tF1">üè¥</span><div class="tf-n" id="tN1">P1</div></div>
      <div class="toss-vs">VS</div>
      <div class="tf"><span class="tf-f" id="tF2">üè¥</span><div class="tf-n" id="tN2">P2</div></div>
    </div>
    <div id="tossHostArea">
      <div style="font-size:.68rem;letter-spacing:2px;color:var(--mut);text-align:center;margin-bottom:10px;">CALL THE TOSS</div>
      <div class="side-btns">
        <button class="side-btn" onclick="pickSide('heads',this)">üëë HEADS</button>
        <button class="side-btn" onclick="pickSide('tails',this)">üîÑ TAILS</button>
      </div>
      <div style="text-align:center;"><div class="coin" id="coin" onclick="flipCoin()">ü™ô</div></div>
    </div>
    <div id="tossGuestArea" style="display:none;" class="wait-pulse">
      <div class="wait-icon">‚è≥</div>
      <div class="wait-txt" id="tossGuestTxt">WAITING FOR HOST...</div>
    </div>
    <div class="toss-res" id="tossRes"></div>
    <div class="bb-btns" id="bbArea" style="display:none;">
      <button class="bb-btn bat" onclick="chooseBB('bat')">üèè BAT FIRST</button>
      <button class="bb-btn bowl" onclick="chooseBB('bowl')">‚öæ BOWL FIRST</button>
    </div>
    <div id="tossWaitChoice" style="display:none;" class="wait-pulse">
      <div class="wait-icon">üèè</div>
      <div class="wait-txt" id="tossWaitChoiceTxt">WAITING FOR CHOICE...</div>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen">
  <div class="scorebar">
    <div class="sb-t" id="sbL">
      <div class="sb-flag" id="sbF1">üè¥</div>
      <div><div class="sb-nm" id="sbN1">P1</div><div class="sb-sc bat" id="sbS1">0/0</div></div>
    </div>
    <div class="sb-mid">
      <div class="sb-inn" id="sbInn">1ST</div>
      <div class="sb-ovc" id="sbOvc">0.0</div>
      <div class="sb-tgt" id="sbTgt"></div>
    </div>
    <div class="sb-t r" id="sbR">
      <div class="sb-flag" id="sbF2">üè¥</div>
      <div style="text-align:right;"><div class="sb-nm" id="sbN2">P2</div><div class="sb-sc fld" id="sbS2">‚Äî</div></div>
    </div>
  </div>
  <div class="game-main">
    <div class="crowd"></div>
    <div class="field">
      <div class="char left">
        <div class="char-svg" id="svgLeft"></div>
        <div class="char-lbl">
          <div class="char-flag" id="cfLeft">üè¥</div>
          <div class="char-name" id="cnLeft">P1</div>
          <div class="char-role bat" id="crLeft">BATTING</div>
        </div>
      </div>
      <div class="pitch-c">
        <div class="pitch">
          <div class="pc t"></div><div class="pc b"></div>
          <div class="stumps ts"><div class="stump"><div class="bail"></div></div><div class="stump"></div><div class="stump"></div></div>
          <div class="stumps bs"><div class="stump"><div class="bail"></div></div><div class="stump"></div><div class="stump"></div></div>
          <div class="ball" id="gameBall"></div>
        </div>
      </div>
      <div class="char right">
        <div class="char-svg" id="svgRight"></div>
        <div class="char-lbl">
          <div class="char-flag" id="cfRight">üè¥</div>
          <div class="char-name" id="cnRight">P2</div>
          <div class="char-role bowl" id="crRight">BOWLING</div>
        </div>
      </div>
    </div>

    <div class="over-row"><span class="olbl">THIS OVER</span><div id="overChips" style="display:flex;gap:6px;flex-wrap:wrap;"></div></div>
    <div class="role-badge wait" id="roleBadge">‚è≥ LOADING...</div>

    <div id="batterCtrl" class="pbar" style="display:none;">
      <div class="pbar-lbl" id="pbarLbl">‚è≥ WAITING FOR BOWL...</div>
      <div id="deliveryBadge" style="margin-bottom:8px;min-height:22px;"></div>
      <div class="pbar-track">
        <div class="pbar-zones" id="pbarZonesFast">
          <div class="pz" style="flex:18%;">DOT</div>
          <div class="pz" style="flex:14%;">1</div>
          <div class="pz" style="flex:10%;">2</div>
          <div class="pz" style="flex:10%;">3</div>
          <div class="pz" style="flex:14%;color:rgba(45,198,83,.6);">FOUR</div>
          <div class="pz" style="flex:12%;color:rgba(201,162,42,.6);">SIX</div>
          <div class="pz" style="flex:22%;color:rgba(230,57,70,.5);">OUT</div>
        </div>
        <div class="pbar-zones" id="pbarZonesSpin" style="display:none;">
          <div class="pz" style="flex:10%;font-size:.55rem;">DOT</div>
          <div class="pz" style="flex:7%;font-size:.55rem;color:rgba(195,155,211,.5);">1</div>
          <div class="pz" style="flex:7%;font-size:.55rem;color:rgba(45,198,83,.5);">4</div>
          <div class="pz" style="flex:7%;font-size:.55rem;color:rgba(201,162,42,.5);">6</div>
          <div class="pz" style="flex:69%;color:rgba(230,57,70,.7);font-size:.75rem;letter-spacing:2px;">‚ò†Ô∏è OUT ZONE</div>
        </div>
        <div class="pbar-fill" id="pbarFill"></div>
      </div>
      <button class="hit-btn" id="hitBtn" onclick="hitBall()" disabled>üèè HIT!</button>
    </div>

    <div id="bowlerCtrl" style="display:none;text-align:center;width:100%;max-width:480px;">
      <div style="font-family:var(--F);font-size:.8rem;letter-spacing:4px;color:var(--gold);margin-bottom:10px;padding:6px 0;border-top:1px solid rgba(201,162,42,.2);border-bottom:1px solid rgba(201,162,42,.2);">üéØ CHOOSE DELIVERY TYPE</div>
      <div class="bowl-type-row">
        <button class="bowl-type-btn" id="btnFast" onclick="selectBowlType('fast',this)">
          <span class="bowl-type-icon">üî•</span>FAST<span class="bowl-type-sub">CONTROL SPEED ¬∑ HIGH PACE</span>
        </button>
        <button class="bowl-type-btn" id="btnSpin" onclick="selectBowlType('spin',this)">
          <span class="bowl-type-icon">üåÄ</span>SPIN<span class="bowl-type-sub">SLOW BALL ¬∑ BIG OUT ZONE</span>
        </button>
      </div>
      <div class="sbar" id="fastBar" style="display:none;">
        <div class="sbar-lbl">‚ö° SET DELIVERY SPEED ‚Äî STOP THE BAR!</div>
        <div class="sbar-track">
          <div class="sbar-zones">
            <div class="sz" style="flex:25%;color:rgba(78,168,222,.6);">SLOW</div>
            <div class="sz" style="flex:25%;color:rgba(45,198,83,.6);">MED</div>
            <div class="sz" style="flex:25%;color:rgba(255,107,53,.7);">FAST</div>
            <div class="sz" style="flex:25%;color:rgba(230,57,70,.8);">FIRE üî•</div>
          </div>
          <div class="sbar-fill fast-mode" id="sbarFill"></div>
        </div>
        <div class="speed-hint">Higher speed = batter's bar moves faster ‚Üí harder to score</div>
      </div>
      <div id="spinInfo" style="display:none;margin:10px 0 14px;">
        <div style="background:rgba(155,89,182,.08);border:1px solid rgba(155,89,182,.3);border-radius:12px;padding:12px 14px;">
          <div style="font-family:var(--F);font-size:.75rem;letter-spacing:2px;color:#c39bd3;margin-bottom:5px;">üåÄ SPIN DELIVERY</div>
          <div style="font-size:.72rem;color:var(--mut);line-height:1.6;">Batter's bar moves <strong style="color:#c39bd3;">slowly</strong> but the <strong style="color:#e63946;">OUT zone is massive</strong>.</div>
        </div>
      </div>
      <button class="bowl-btn" id="bowlBtn" onclick="bowlBall()" disabled style="width:100%;margin-top:4px;">‚öæ BOWL!</button>
    </div>

    <div id="waitCtrl" style="display:none;" class="wait-pulse">
      <div class="wait-icon">‚è≥</div>
      <div class="wait-txt" id="waitTxt">WAITING...</div>
    </div>
  </div>
</div>

<!-- INNINGS BREAK -->
<div id="breakScreen" class="screen">
  <div class="topbar"><div><div class="topbar-logo">INNINGS BREAK</div></div></div>
  <div class="card">
    <div class="brk-flags" id="brkFlags"></div>
    <div class="brk-title">BREAK TIME</div>
    <div class="brk-sub" id="brkSub"></div>
    <div class="tgt-box"><div class="tgt-n" id="brkTgt">0</div><div class="tgt-s">TARGET TO WIN</div></div>
    <div class="chase-ln" id="chaseLn"></div>
    <button class="btn btn-gold" onclick="readyForInnings2()">READY FOR 2ND INNINGS ‚Üí</button>
    <div id="breakStatus" style="margin-top:10px;"></div>
  </div>
</div>

<!-- SCORECARD -->
<div id="scorecardScreen" class="screen">
  <div class="topbar"><div><div class="topbar-logo">MATCH OVER</div></div></div>
  <div class="card">
    <span class="sc-trophy">üèÜ</span>
    <span class="sc-wf" id="scWF"></span>
    <div class="sc-wn" id="scWN"></div>
    <div class="sc-r" id="scR"></div>
    <div class="sc-it" id="scT1"></div>
    <table class="sc-t"><thead><tr><th>PLAYER</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead><tbody id="scB1"></tbody></table>
    <div class="sc-it" id="scT2"></div>
    <table class="sc-t"><thead><tr><th>PLAYER</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead><tbody id="scB2"></tbody></table>

    <div id="rematchArea" style="margin-top:20px;">
      <div id="rematchBtns">
        <button class="btn btn-rematch" id="rematchBtn" onclick="requestRematch()">üîÅ REMATCH ‚Äî SAME TEAMS</button>
        <button class="btn btn-ghost" style="margin-top:8px;" onclick="playAgain()">üè† Back to Home</button>
      </div>
      <div id="rematchWait" style="display:none;">
        <div class="status wait" style="margin-bottom:10px;"><span class="dot"></span> <span id="rematchWaitTxt">Waiting for opponent...</span></div>
        <button class="btn btn-ghost" style="margin-top:4px;" onclick="playAgain()">üè† Cancel ‚Äî Go Home</button>
      </div>
      <div id="rematchIncoming" style="display:none;">
        <div style="background:rgba(45,198,83,.08);border:1px solid rgba(45,198,83,.3);border-radius:12px;padding:14px;text-align:center;margin-bottom:10px;">
          <div style="font-family:var(--F);font-size:.8rem;letter-spacing:2px;color:var(--grn);margin-bottom:6px;">üîÅ REMATCH REQUESTED!</div>
          <div style="font-size:.75rem;color:var(--mut);" id="rematchIncomingTxt">Opponent wants to play again</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-rematch" style="margin-top:0;" onclick="acceptRematch()">‚úÖ ACCEPT</button>
          <button class="btn btn-ghost" style="margin-top:0;flex:0.5;" onclick="playAgain()">‚ùå Decline</button>
        </div>
      </div>
    </div>
  </div>
</div>

</div>
<div id="splash"><div class="sp-in"><div class="sp-r" id="spR">6</div><div class="sp-m" id="spM">MAXIMUM!</div></div></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTRIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CNTRY=[
  {id:'ind',name:'INDIA',flag:'üáÆüá≥',j:'#003f88',j2:'#002a5c',a:'#ff9933',h:'#003f88'},
  {id:'aus',name:'AUSTRALIA',flag:'üá¶üá∫',j:'#ffcd00',j2:'#c49b00',a:'#006400',h:'#1a1a1a'},
  {id:'eng',name:'ENGLAND',flag:'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø',j:'#003087',j2:'#001a5c',a:'#cc0000',h:'#1a1a1a'},
  {id:'pak',name:'PAKISTAN',flag:'üáµüá∞',j:'#006633',j2:'#004422',a:'#ffffff',h:'#004d26'},
  {id:'sa',name:'S.AFRICA',flag:'üáøüá¶',j:'#007a4d',j2:'#004d30',a:'#ffb81c',h:'#006640'},
  {id:'nz',name:'NEW ZEALAND',flag:'üá≥üáø',j:'#1a1a1a',j2:'#000',a:'#cc0000',h:'#111'},
  {id:'wi',name:'WEST INDIES',flag:'üå¥',j:'#8b0000',j2:'#5a0000',a:'#ffcc00',h:'#700000'},
  {id:'sl',name:'SRI LANKA',flag:'üá±üá∞',j:'#1a3a7a',j2:'#0a2050',a:'#ffcc00',h:'#0d2a60'},
  {id:'ban',name:'BANGLADESH',flag:'üáßüá©',j:'#006a4e',j2:'#004433',a:'#f42a41',h:'#004d38'},
  {id:'afg',name:'AFGHANISTAN',flag:'üá¶üá´',j:'#1b3f7a',j2:'#0d2550',a:'#cc0000',h:'#102d5a'},
  {id:'ire',name:'IRELAND',flag:'üáÆüá™',j:'#1a6b3a',j2:'#0d4525',a:'#ff8c00',h:'#145030'},
  {id:'zim',name:'ZIMBABWE',flag:'üáøüáº',j:'#c8102e',j2:'#8a0020',a:'#009a44',h:'#a00020'},
];
const cbyid=id=>CNTRY.find(c=>c.id===id)||CNTRY[0];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROF_KEY='icc_cricket_profile';
let savedProfile=null;

function loadProfile(){
  try{savedProfile=JSON.parse(localStorage.getItem(PROF_KEY));}catch(e){}
  if(savedProfile&&savedProfile.name&&savedProfile.country){
    playerCountry=cbyid(savedProfile.country);
    goTo('homeScreen');
    refreshHomeBadge();
    prefillInviteScreens();
  } else {
    goTo('profileScreen');
  }
}

function saveProfile(){
  const name=document.getElementById('profName').value.trim();
  if(!name){setStatus('profStatus','err','‚ùå Please enter your name!');return;}
  savedProfile={name,country:profSelectedCountry.id};
  localStorage.setItem(PROF_KEY,JSON.stringify(savedProfile));
  playerCountry=profSelectedCountry;
  refreshHomeBadge();
  prefillInviteScreens();
  goTo('homeScreen');
}

function refreshHomeBadge(){
  if(!savedProfile)return;
  const c=cbyid(savedProfile.country);
  document.getElementById('homeProfFlag').textContent=c.flag;
  document.getElementById('homeProfName').textContent=savedProfile.name;
  document.getElementById('homeProfCountry').textContent=c.name+' ¬∑ TAP TO EDIT';
}

function prefillInviteScreens(){
  if(!savedProfile)return;
  document.getElementById('hostName').value=savedProfile.name;
  document.getElementById('guestName').value=savedProfile.name;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ROLE=null, peer=null, conn=null, GS=null;
let myOvers=5, hostOvers=5;
let playerCountry=CNTRY[0], profSelectedCountry=CNTRY[0];
let hostCountry=CNTRY[0], guestCountry=CNTRY[1];
let tossPick=null;
let barT=null,barRunning=false,barPos=0,barDir=1;
let sbarT=null,sbarRunning=false,sbarPos=0,sbarDir=1;
let currentBowlType=null, receivedBowlType='fast';
let myKey=null;
let rematchHostReady=false, rematchGuestReady=false;
let myPeerId=null, searchTimer=null, searchAttempt=0;
let IS_AI=false;
let aiCountdownTimer=null, aiCountdownVal=30;
let MATCH_MODE='auto'; // 'auto' | 'invite'
let innings2HostReady=false, innings2GuestReady=false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKGROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bgC=document.getElementById('bgC'),bgX=bgC.getContext('2d');
const fxC=document.getElementById('fxC'),fxX=fxC.getContext('2d');
function resize(){bgC.width=fxC.width=window.innerWidth;bgC.height=fxC.height=window.innerHeight;drawBG();}
function drawBG(){
  const W=bgC.width,H=bgC.height,g=bgX.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#010810');g.addColorStop(.65,'#07122a');g.addColorStop(1,'#0a1f10');
  bgX.fillStyle=g;bgX.fillRect(0,0,W,H);
  for(let i=0;i<120;i++){bgX.beginPath();bgX.arc(Math.random()*W,Math.random()*H*.5,Math.random()*1.1,0,Math.PI*2);bgX.fillStyle=`rgba(255,255,255,${.15+Math.random()*.5})`;bgX.fill();}
  bgX.beginPath();bgX.ellipse(W/2,H*.28,W*.44,H*.14,0,Math.PI,Math.PI*2);
  bgX.strokeStyle='rgba(50,80,130,.5)';bgX.lineWidth=12;bgX.stroke();
}
resize();window.addEventListener('resize',resize);
let PX=[];
function fw(col){const cx=fxC.width/2,cy=fxC.height*.35;for(let i=0;i<80;i++){const a=Math.random()*Math.PI*2,sp=2+Math.random()*7;PX.push({x:cx+(Math.random()-.5)*100,y:cy+(Math.random()-.5)*55,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1.5,life:1,decay:.012+Math.random()*.013,size:2+Math.random()*3.5,color:col});}}
function bpop(){for(let i=0;i<40;i++)PX.push({x:Math.random()*fxC.width,y:fxC.height,vx:(Math.random()-.5)*5,vy:-(4+Math.random()*7),life:1,decay:.018,size:3+Math.random()*4,color:`hsl(${110+Math.random()*50},80%,55%)`});}
function wfx(){const cx=fxC.width/2,cy=fxC.height*.5;for(let i=0;i<50;i++){const a=Math.random()*Math.PI*2;PX.push({x:cx,y:cy,vx:Math.cos(a)*(2+Math.random()*5),vy:Math.sin(a)*(2+Math.random()*5),life:1,decay:.017,size:2+Math.random()*3,color:`hsl(${Math.random()*30},90%,55%)`});}}
(function tick(){fxX.clearRect(0,0,fxC.width,fxC.height);PX=PX.filter(p=>p.life>0);PX.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life-=p.decay;fxX.globalAlpha=Math.max(0,p.life);fxX.fillStyle=p.color;fxX.beginPath();fxX.arc(p.x,p.y,p.size,0,Math.PI*2);fxX.fill();});fxX.globalAlpha=1;requestAnimationFrame(tick);})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SVGs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function batSVG(c){return`<svg viewBox="0 0 80 160" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="40" cy="157" rx="26" ry="5" fill="rgba(0,0,0,.4)"/>
  <rect x="26" y="106" width="13" height="50" rx="6" fill="${c.j2}"/>
  <rect x="41" y="106" width="13" height="50" rx="6" fill="${c.j2}"/>
  <ellipse cx="32" cy="155" rx="10" ry="5" fill="#111"/>
  <ellipse cx="48" cy="155" rx="10" ry="5" fill="#111"/>
  <rect x="19" y="66" width="42" height="44" rx="9" fill="${c.j}"/>
  <rect x="19" y="77" width="42" height="5" fill="${c.a}" opacity=".5"/>
  <rect x="7" y="68" width="13" height="38" rx="6" fill="${c.j}"/>
  <rect x="59" y="60" width="13" height="42" rx="6" fill="${c.j}" transform="rotate(-25 65 81)"/>
  <rect x="0" y="55" width="10" height="62" rx="4" fill="#d4a030"/>
  <rect x="1" y="55" width="3" height="62" rx="2" fill="rgba(255,255,255,.18)"/>
  <rect x="32" y="50" width="16" height="19" rx="7" fill="#d49060"/>
  <ellipse cx="40" cy="38" rx="22" ry="21" fill="${c.h}"/>
  <path d="M18 48 Q40 65 62 48" stroke="${c.a}" stroke-width="4" fill="none" opacity=".8"/>
  <circle cx="33" cy="36" r="3.5" fill="#fff"/><circle cx="47" cy="36" r="3.5" fill="#fff"/>
  <circle cx="34" cy="37" r="2" fill="#111"/><circle cx="48" cy="37" r="2" fill="#111"/>
</svg>`;}

function bowlSVG(c){return`<svg viewBox="0 0 80 160" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="40" cy="157" rx="26" ry="5" fill="rgba(0,0,0,.4)"/>
  <rect x="27" y="104" width="13" height="52" rx="6" fill="${c.j2}"/>
  <rect x="40" y="104" width="13" height="52" rx="6" fill="${c.j2}"/>
  <ellipse cx="33" cy="155" rx="10" ry="5" fill="#111"/>
  <ellipse cx="46" cy="155" rx="10" ry="5" fill="#111"/>
  <rect x="19" y="62" width="42" height="46" rx="9" fill="${c.j}"/>
  <rect x="19" y="73" width="42" height="5" fill="${c.a}" opacity=".5"/>
  <rect x="7" y="52" width="13" height="42" rx="6" fill="${c.j}" transform="rotate(22 13 73)"/>
  <circle cx="10" cy="54" r="9" fill="${c.j}"/>
  <circle cx="10" cy="54" r="7" fill="#cc1111" stroke="#880000" stroke-width="1.5"/>
  <path d="M4 54 Q10 48 16 54" stroke="rgba(255,255,255,.25)" stroke-width="1" fill="none"/>
  <rect x="58" y="70" width="12" height="36" rx="6" fill="${c.j}"/>
  <rect x="32" y="48" width="16" height="18" rx="7" fill="#d49060"/>
  <ellipse cx="40" cy="37" rx="22" ry="20" fill="${c.h}"/>
  <path d="M18 43 Q40 60 62 43" stroke="${c.a}" stroke-width="4" fill="none" opacity=".9"/>
  <circle cx="33" cy="35" r="3.5" fill="#fff"/><circle cx="47" cy="35" r="3.5" fill="#fff"/>
  <circle cx="34" cy="36" r="2" fill="#111"/><circle cx="48" cy="36" r="2" fill="#111"/>
</svg>`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTRY GRIDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildGrid(gid,defSel,onPick){
  const g=document.getElementById(gid);if(!g)return;g.innerHTML='';
  let cur=defSel;
  CNTRY.forEach(c=>{
    const d=document.createElement('div');
    d.className='cc'+(c.id===cur.id?' sel':'');
    d.innerHTML=`<span class="cc-f">${c.flag}</span><div class="cc-n">${c.name}</div>`;
    d.onclick=()=>{cur=c;onPick(c);g.querySelectorAll('.cc').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');};
    g.appendChild(d);
  });
}
buildGrid('profGrid',profSelectedCountry,c=>{profSelectedCountry=c;playerCountry=c;});
buildGrid('hostGrid',hostCountry,c=>hostCountry=c);
buildGrid('guestGrid',guestCountry,c=>guestCountry=c);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV + UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTo(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function setStatus(id,type,msg){const el=document.getElementById(id);if(el)el.innerHTML=`<div class="status ${type}">${msg}</div>`;}
function setConnDot(state){const d=document.getElementById('connDot');d.className='';if(state)d.classList.add(state);}
function setOvers(n,el){myOvers=n;document.getElementById('overRow').querySelectorAll('.oc').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');}
function setHostOv(n,el){hostOvers=n;document.getElementById('hostOcRow').querySelectorAll('.oc').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');}

function switchTab(mode){
  MATCH_MODE=mode;
  document.getElementById('tabAuto').className='mode-tab'+(mode==='auto'?' active':'');
  document.getElementById('tabInvite').className='mode-tab'+(mode==='invite'?' active':'');
  document.getElementById('autoMatchCard').style.display=mode==='auto'?'':'none';
  document.getElementById('searchingCard').style.display='none';
  document.getElementById('inviteCard').style.display=mode==='invite'?'':'none';
}

function goToJoin(){
  goTo('inviteJoinScreen');
  // Check for URL peer param
  const urlPeer=new URLSearchParams(location.search).get('peer');
  if(urlPeer) document.getElementById('guestCode').value=urlPeer;
}

// Server status check
(function initServerStatus(){
  const tp=new Peer(undefined,{debug:0});
  tp.on('open',()=>{document.getElementById('onlineTxt').textContent='SERVERS ONLINE ‚Äî READY TO MATCH';tp.destroy();});
  tp.on('error',()=>{document.getElementById('onlineTxt').textContent='OFFLINE MODE ‚Äî CHECK CONNECTION';});
})();

// Boot
window.addEventListener('load',()=>setTimeout(loadProfile,2100));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO MATCHMAKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function lobbyId(overs){return'icc-t20-ult-'+overs+'ov';}

function findMatch(){
  if(!savedProfile){setStatus('matchStatus','err','‚ùå Set up your profile first!');goTo('profileScreen');return;}
  const name=savedProfile.name;
  playerCountry=cbyid(savedProfile.country);
  document.getElementById('findBtn').disabled=true;
  document.getElementById('searchingCard').style.display='block';
  document.getElementById('matchStatus').innerHTML='';
  setConnDot('connecting');
  IS_AI=false;MATCH_MODE='auto';
  startCountdown(30,()=>launchAIMatch(name));
  if(peer){try{peer.destroy();}catch(e){}peer=null;}
  searchAttempt=0;
  _tryMatchmake(name);
}

function startCountdown(seconds,onExpire){
  aiCountdownVal=seconds;
  const numEl=document.getElementById('countdownNum');
  const ringEl=document.getElementById('cringFg');
  const circ=238.76;
  function tick(){
    if(numEl)numEl.textContent=aiCountdownVal;
    if(ringEl)ringEl.style.strokeDashoffset=circ*(1-aiCountdownVal/seconds);
    if(ringEl)ringEl.style.stroke=aiCountdownVal<=10?'var(--red)':'var(--gold)';
    if(numEl)numEl.style.color=aiCountdownVal<=10?'var(--red)':'var(--gold)';
    if(aiCountdownVal<=0){clearInterval(aiCountdownTimer);onExpire();return;}
    aiCountdownVal--;
  }
  tick();aiCountdownTimer=setInterval(tick,1000);
}

function stopCountdown(){clearInterval(aiCountdownTimer);aiCountdownTimer=null;}

function _tryMatchmake(name){
  if(IS_AI)return;
  const lId=lobbyId(myOvers)+'-'+(searchAttempt%5);
  document.getElementById('searchTxt').textContent='SEARCHING FOR OPPONENT...';
  document.getElementById('searchSub').textContent='Attempt '+(searchAttempt+1)+' ‚Äî overs: '+myOvers;
  peer=new Peer(lId,{debug:0});
  peer.on('open',id=>{
    if(IS_AI){try{peer.destroy();}catch(e){}return;}
    myPeerId=id;ROLE='host';myKey='p1';
    document.getElementById('searchTxt').textContent='WAITING FOR OPPONENT...';
    document.getElementById('searchSub').textContent='Real player or AI in '+aiCountdownVal+'s';
    setConnDot('connected');
    GS={p1:{name,country:playerCountry.id},p2:null,overs:myOvers,innings:1,batting:'p1',over:0,ball:0,overBalls:[],target:null,scores:{p1:{r:0,w:0,b:0,f:0,s:0},p2:{r:0,w:0,b:0,f:0,s:0}},toss:{pick:null,result:null,winner:null,batting:null},state:'waiting'};
    peer.on('connection',c=>{
      if(IS_AI){c.close();return;}
      stopCountdown();conn=c;
      c.on('open',()=>{setConnDot('connected');clearTimeout(searchTimer);});
      c.on('data',onGuestMsg);
      c.on('close',()=>{setConnDot('');handleDisconnect();});
    });
    searchTimer=setTimeout(()=>{
      if(!conn&&!IS_AI){searchAttempt++;if(peer){try{peer.destroy();}catch(e){}peer=null;}_tryMatchmake(name);}
    },12000);
  });
  peer.on('error',e=>{
    if(IS_AI)return;
    if(e.type==='unavailable-id'){if(peer){try{peer.destroy();}catch(e2){}peer=null;}_joinAsGuest(name,lId);}
    else{setTimeout(()=>{if(IS_AI)return;searchAttempt++;if(peer){try{peer.destroy();}catch(e2){}peer=null;}_tryMatchmake(name);},2000);}
  });
}

function _joinAsGuest(name,hostLobbyId){
  if(IS_AI)return;
  ROLE='guest';myKey='p2';
  document.getElementById('searchTxt').textContent='OPPONENT FOUND! üéâ';
  document.getElementById('searchSub').textContent='Connecting...';
  peer=new Peer(undefined,{debug:0});
  peer.on('open',()=>{
    if(IS_AI){try{peer.destroy();}catch(e){}return;}
    conn=peer.connect(hostLobbyId,{reliable:true});
    conn.on('open',()=>{stopCountdown();setConnDot('connected');document.getElementById('searchTxt').textContent='MATCH FOUND! üéâ';send({type:'guest_join',name,country:playerCountry.id});});
    conn.on('data',onHostMsg);
    conn.on('close',()=>{if(!IS_AI){setConnDot('');handleDisconnect();}});
  });
  peer.on('error',()=>{if(IS_AI)return;searchAttempt++;if(peer){try{peer.destroy();}catch(e){}peer=null;}_tryMatchmake(name);});
}

function cancelSearch(){
  stopCountdown();clearTimeout(searchTimer);
  if(peer){try{peer.destroy();}catch(e){}peer=null;}
  conn=null;ROLE=null;IS_AI=false;
  document.getElementById('searchingCard').style.display='none';
  document.getElementById('findBtn').disabled=false;
  setConnDot('');
  setStatus('matchStatus','info','Search cancelled.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI MATCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI countries ordered by ICC T20 ranking performance (best ‚Üí weakest)
// Each has a skill profile: winRate affects scoring patterns
const AI_TEAMS=[
  {id:'ind', name:'INDIA',       flag:'üáÆüá≥', rating:1, label:'World No.1 ‚Äî VERY HARD',   winRate:0.82},
  {id:'aus', name:'AUSTRALIA',   flag:'üá¶üá∫', rating:2, label:'World No.2 ‚Äî VERY HARD',   winRate:0.78},
  {id:'eng', name:'ENGLAND',     flag:'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', rating:3, label:'World No.3 ‚Äî HARD',        winRate:0.72},
  {id:'pak', name:'PAKISTAN',    flag:'üáµüá∞', rating:4, label:'World No.4 ‚Äî HARD',        winRate:0.68},
  {id:'sa',  name:'S.AFRICA',    flag:'üáøüá¶', rating:5, label:'World No.5 ‚Äî MEDIUM',      winRate:0.62},
  {id:'nz',  name:'NEW ZEALAND', flag:'üá≥üáø', rating:6, label:'World No.6 ‚Äî MEDIUM',      winRate:0.57},
  {id:'wi',  name:'WEST INDIES', flag:'üå¥', rating:7, label:'World No.7 ‚Äî MEDIUM',      winRate:0.52},
  {id:'sl',  name:'SRI LANKA',   flag:'üá±üá∞', rating:8, label:'World No.8 ‚Äî EASY',        winRate:0.45},
  {id:'ban', name:'BANGLADESH',  flag:'üáßüá©', rating:9, label:'World No.9 ‚Äî EASY',        winRate:0.40},
  {id:'afg', name:'AFGHANISTAN', flag:'üá¶üá´', rating:10,label:'World No.10 ‚Äî EASY',       winRate:0.35},
  {id:'ire', name:'IRELAND',     flag:'üáÆüá™', rating:11,label:'World No.11 ‚Äî VERY EASY',  winRate:0.28},
  {id:'zim', name:'ZIMBABWE',    flag:'üáøüáº', rating:12,label:'World No.12 ‚Äî VERY EASY',  winRate:0.22},
];
let selectedAITeam = AI_TEAMS[1]; // default Australia

function launchAIMatch(playerName){
  if(conn)return;
  IS_AI=true;
  if(peer){try{peer.destroy();}catch(e){}peer=null;}
  clearTimeout(searchTimer);
  document.getElementById('searchTxt').textContent='ü§ñ CHOOSE YOUR OPPONENT!';
  document.getElementById('searchSub').textContent='Select AI country to battle';
  document.getElementById('searchingCard').style.display='none';
  document.getElementById('findBtn').disabled=false;
  setConnDot('');
  showAICountryPicker(playerName);
}

function showAICountryPicker(playerName){
  // Build AI picker modal
  let existing = document.getElementById('aiPickerModal');
  if(existing) existing.remove();

  const avail = AI_TEAMS.filter(t => t.id !== playerCountry.id);

  const modal = document.createElement('div');
  modal.id = 'aiPickerModal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow-y:auto;padding:20px 14px 40px;';

  let html = `<div style="width:100%;max-width:460px;">
    <div style="font-family:var(--F);font-size:1.1rem;letter-spacing:4px;color:var(--gold);text-align:center;margin-bottom:4px;padding-top:12px;">ü§ñ CHOOSE AI OPPONENT</div>
    <div style="font-size:.68rem;letter-spacing:2px;color:var(--mut);text-align:center;margin-bottom:16px;">TEAMS RANKED BY ICC T20 PERFORMANCE</div>`;

  avail.forEach((team, i) => {
    const diffColor = team.rating<=2?'#e63946':team.rating<=4?'#ff6b35':team.rating<=7?'#f0c840':team.rating<=9?'#2dc653':'#7a90b8';
    html += `<div onclick="selectAITeam('${team.id}','${playerName}')" style="display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.09);border-radius:12px;padding:13px 14px;margin-bottom:8px;cursor:pointer;transition:all .15s;" onmouseover="this.style.borderColor='rgba(201,162,42,.4)';this.style.background='rgba(201,162,42,.06)'" onmouseout="this.style.borderColor='rgba(255,255,255,.09)';this.style.background='rgba(255,255,255,.04)'">
      <div style="font-size:2rem;flex-shrink:0;">${team.flag}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-family:var(--F);font-size:.9rem;letter-spacing:2px;color:#eef2ff;">${team.name}</div>
        <div style="font-size:.6rem;color:${diffColor};letter-spacing:1px;margin-top:2px;">${team.label}</div>
      </div>
      <div style="font-family:var(--F);font-size:1.1rem;color:rgba(255,255,255,.2);">#${team.rating}</div>
    </div>`;
  });

  html += `<button onclick="document.getElementById('aiPickerModal').remove();cancelSearch();" style="width:100%;padding:12px;margin-top:8px;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:rgba(255,255,255,.05);color:var(--mut);font-family:var(--F);font-size:.85rem;letter-spacing:1px;cursor:pointer;">‚úï CANCEL</button>
  </div>`;

  modal.innerHTML = html;
  document.body.appendChild(modal);
}

function selectAITeam(countryId, playerName){
  selectedAITeam = AI_TEAMS.find(t=>t.id===countryId) || AI_TEAMS[1];
  const modal = document.getElementById('aiPickerModal');
  if(modal) modal.remove();
  ROLE='host';myKey='p1';
  GS={p1:{name:playerName,country:playerCountry.id},p2:{name:selectedAITeam.flag+' '+selectedAITeam.name,country:selectedAITeam.id},overs:myOvers,innings:1,batting:'p1',over:0,ball:0,overBalls:[],target:null,scores:{p1:{r:0,w:0,b:0,f:0,s:0},p2:{r:0,w:0,b:0,f:0,s:0}},toss:{pick:null,result:null,winner:null,batting:null},state:'toss'};
  setTimeout(()=>startToss('host'), 200);
}

function handleDisconnect(){
  if(IS_AI)return;
  if(GS&&GS.state==='done')return;
  alert('‚ö†Ô∏è Opponent disconnected. Returning to lobby.');
  if(MATCH_MODE==='auto')cancelSearch();
  goTo('homeScreen');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVITE MODE: HOST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createRoom(){
  const name=document.getElementById('hostName').value.trim();
  if(!name){setStatus('hostStatus','err','‚ùå Enter your name first!');return;}
  document.getElementById('createBtn').disabled=true;
  setStatus('hostStatus','wait','<span class="dot"></span> Connecting to network...');
  setConnDot('connecting');
  ROLE='host';myKey='p1';IS_AI=false;MATCH_MODE='invite';
  peer=new Peer(undefined,{debug:0});
  peer.on('open',id=>{
    setConnDot('connected');
    const shareUrl=makeShareUrl(id);
    document.getElementById('shareBox').style.display='block';
    document.getElementById('shareLink').textContent=shareUrl;
    document.getElementById('hostStatus').innerHTML='<div class="status ok">‚úÖ Room ready! Share the link below.</div>';
    GS={p1:{name,country:hostCountry.id},p2:null,overs:hostOvers,innings:1,batting:'p1',over:0,ball:0,overBalls:[],target:null,scores:{p1:{r:0,w:0,b:0,f:0,s:0},p2:{r:0,w:0,b:0,f:0,s:0}},toss:{pick:null,result:null,winner:null,batting:null},state:'waiting'};
  });
  peer.on('connection',c=>{
    conn=c;setConnDot('connecting');
    c.on('open',()=>{setConnDot('connected');document.getElementById('waitingStatus').innerHTML='<div class="status ok">‚úÖ Opponent connected! Starting match...</div>';});
    c.on('data',onGuestMsg);
    c.on('close',()=>{setConnDot('');handleDisconnect();});
  });
  peer.on('error',e=>{
    setConnDot('');
    setStatus('hostStatus','err','‚ùå Network error: '+e.message);
    document.getElementById('createBtn').disabled=false;
  });
}

function makeShareUrl(peerId){
  const base=window.location.href.split('?')[0];
  return base+'?peer='+peerId;
}
function shareWhatsApp(){
  const link=document.getElementById('shareLink').textContent;
  const msg=`üèè Join my ICC T20 Cricket match!\n\nTap to play:\n${link}\n\nJoins directly to my game! üéØ`;
  window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
}
function copyLink(){
  const link=document.getElementById('shareLink').textContent;
  try{
    navigator.clipboard.writeText(link).then(()=>{
      const btn=document.getElementById('copyBtn');btn.textContent='‚úÖ Copied!';setTimeout(()=>btn.textContent='üìã Copy',2000);
    });
  }catch(e){prompt('Copy this link:',link);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVITE MODE: GUEST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function joinRoom(){
  const name=document.getElementById('guestName').value.trim();
  let code=document.getElementById('guestCode').value.trim();
  const urlPeer=new URLSearchParams(location.search).get('peer');
  if(!code&&urlPeer)code=urlPeer;
  if(!name){setStatus('joinStatus','err','‚ùå Enter your name first!');return;}
  if(!code){setStatus('joinStatus','err','‚ùå Paste the room code from the host link');return;}
  ROLE='guest';myKey='p2';IS_AI=false;MATCH_MODE='invite';
  setStatus('joinStatus','wait','<span class="dot"></span> Connecting to host...');
  setConnDot('connecting');
  peer=new Peer(undefined,{debug:0});
  peer.on('open',()=>{
    conn=peer.connect(code,{reliable:true});
    conn.on('open',()=>{setConnDot('connected');setStatus('joinStatus','ok','‚úÖ Connected! Waiting for host...');send({type:'guest_join',name,country:guestCountry.id});});
    conn.on('data',onHostMsg);
    conn.on('close',()=>{setConnDot('');handleDisconnect();});
  });
  peer.on('error',e=>{setConnDot('');setStatus('joinStatus','err','‚ùå Could not connect. Error: '+e.type);});
}

// Auto-join if URL has peer param
(function checkAutoJoin(){
  const urlPeer=new URLSearchParams(location.search).get('peer');
  if(urlPeer){
    // Will switch to invite tab and go to join screen after splash
    setTimeout(()=>{
      switchTab('invite');
      goTo('inviteJoinScreen');
      document.getElementById('guestCode').value=urlPeer;
      // Show invite link banner
      const card=document.querySelector('#inviteJoinScreen .card');
      const banner=document.createElement('div');
      banner.className='status ok';banner.style.marginBottom='14px';
      banner.innerHTML='‚úÖ Invite link detected! Enter your name, then JOIN.';
      card.insertBefore(banner,card.firstChild);
    },2200);
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function send(data){if(conn&&conn.open){try{conn.send(data);}catch(e){}}}

function onGuestMsg(data){
  switch(data.type){
    case 'guest_join': GS.p2={name:data.name,country:data.country};send({type:'start_toss',gs:GS});startToss('host');break;
    case 'bb_choice': applyBBChoice(data.choice);break;
    case 'bowl': onBowlReceived(data.speed||50,data.bowlType||'fast');break;
    case 'hit': applyHit(data.result,false);break;
    case 'innings2_ready': handleInnings2Ready();break;
    case 'rematch_request': onRematchRequest();break;
    case 'rematch_accept': onRematchAccepted();break;
  }
}

function onHostMsg(data){
  switch(data.type){
    case 'start_toss': GS=data.gs;startToss('guest');break;
    case 'toss_result': showTossResult(data);break;
    case 'game_start': GS=data.gs;startGame();break;
    case 'bowl': onBowlReceived(data.speed||50,data.bowlType||'fast');break;
    case 'hit': applyHit(data.result,false);break;
    case 'innings_break': GS=data.gs;showBreak();break;
    case 'innings2_start': GS=data.gs;startInnings2();break;
    case 'game_over': GS=data.gs;showScorecard();break;
    case 'sync': GS=data.gs;refreshScoreboard();break;
    case 'rematch_request': onRematchRequest();break;
    case 'rematch_accept': onRematchAccepted();break;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOSS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startToss(who){
  const c1=cbyid(GS.p1.country),c2=cbyid(GS.p2.country);
  document.getElementById('tF1').textContent=c1.flag;document.getElementById('tN1').textContent=GS.p1.name;
  document.getElementById('tF2').textContent=c2.flag;document.getElementById('tN2').textContent=GS.p2.name;
  document.getElementById('tossRes').textContent='';document.getElementById('bbArea').style.display='none';document.getElementById('tossWaitChoice').style.display='none';
  if(who==='host'){
    document.getElementById('tossHostArea').style.display='block';document.getElementById('tossGuestArea').style.display='none';
    document.getElementById('tossSubLbl').textContent=GS.p1.name.toUpperCase()+' CALLS';
  // Show AI difficulty banner if AI match
  if(IS_AI && selectedAITeam){
    const diffRating = selectedAITeam.rating;
    const diffCls = diffRating<=2?'vhard':diffRating<=4?'hard':diffRating<=7?'medium':'easy';
    const existing = document.getElementById('aiDiffBanner');
    if(!existing){
      const banner = document.createElement('div');
      banner.id='aiDiffBanner';
      banner.style.cssText='text-align:center;margin:0 0 14px;';
      banner.innerHTML=`<span style="font-size:.65rem;letter-spacing:2px;color:var(--mut);">YOU ARE FACING </span><strong style="color:#eef2ff;font-family:var(--F);">${selectedAITeam.flag} ${selectedAITeam.name}</strong><br><span class="diff-badge diff-${diffCls}">${selectedAITeam.label}</span>`;
      const card=document.querySelector('#tossScreen .card');
      card.insertBefore(banner, card.firstChild);
    }
  }
  }else{
    document.getElementById('tossHostArea').style.display='none';document.getElementById('tossGuestArea').style.display='block';
    document.getElementById('tossGuestTxt').textContent='WAITING FOR '+GS.p1.name.toUpperCase()+' TO FLIP...';
    document.getElementById('tossSubLbl').textContent='WAITING...';
  }
  goTo('tossScreen');
}

function pickSide(side,el){tossPick=side;document.querySelectorAll('.side-btn').forEach(b=>b.classList.remove('ch'));el.classList.add('ch');}

function flipCoin(){
  if(!tossPick){showSplash('PICK!','Pick heads or tails','#e63946');return;}
  const coin=document.getElementById('coin');
  coin.style.pointerEvents='none';coin.classList.add('flip');
  setTimeout(()=>{
    coin.classList.remove('flip');coin.style.pointerEvents='';
    const result=Math.random()<.5?'heads':'tails';
    coin.textContent=result==='heads'?'üëë':'üîÑ';
    const won=result===tossPick;
    const winner=won?'p1':'p2';
    GS.toss={pick:tossPick,result,winner,batting:null};
    const msg=result.toUpperCase()+'! '+(won?'‚úÖ '+GS.p1.name+' WINS THE TOSS!':'‚ùå '+GS.p2.name+' WINS THE TOSS!');
    document.getElementById('tossRes').textContent=msg;
    document.getElementById('tossHostArea').style.display='none';
    send({type:'toss_result',result,winner,msg});
    if(won){
      document.getElementById('bbArea').style.display='flex';
    }else{
      if(IS_AI){
        setTimeout(()=>{
          const aiChoice=Math.random()<0.5?'bat':'bowl';
          setTimeout(()=>chooseBB(aiChoice==='bat'?'bowl':'bat'),800);
        },900);
      }else{
        document.getElementById('tossWaitChoice').style.display='block';
        document.getElementById('tossWaitChoiceTxt').textContent=GS.p2.name.toUpperCase()+' IS CHOOSING...';
      }
    }
  },1450);
}

function showTossResult(data){
  document.getElementById('tossGuestArea').style.display='none';
  document.getElementById('tossRes').textContent=data.msg;
  GS.toss={result:data.result,winner:data.winner};
  if(data.winner==='p2'){document.getElementById('bbArea').style.display='flex';}
  else{document.getElementById('tossWaitChoice').style.display='block';document.getElementById('tossWaitChoiceTxt').textContent=GS.p1.name.toUpperCase()+' IS CHOOSING...';}
}

function chooseBB(choice){
  const winner=GS.toss.winner;
  const batting=choice==='bat'?winner:(winner==='p1'?'p2':'p1');
  GS.toss.batting=batting;GS.batting=batting;GS.state='game';
  if(ROLE==='host'){send({type:'game_start',gs:GS});startGame();}
  else{send({type:'bb_choice',choice});startGame();}
}
function applyBBChoice(choice){
  const winner=GS.toss.winner;
  const batting=choice==='bat'?winner:(winner==='p1'?'p2':'p1');
  GS.toss.batting=batting;GS.batting=batting;GS.state='game';
  send({type:'game_start',gs:GS});startGame();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI TURN LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI DIFFICULTY TIERS
// Tier 5=Very Hard (India/Aus), 4=Hard, 3=Medium, 2=Easy, 1=Very Easy (Zim)
// These produce DRAMATICALLY different gameplay:
//   Very Hard: bar moves 4.2-5.5px/frame, AI bats at ~17 RPO, 5% wicket chance
//   Very Easy: bar moves 0.8-1.4px/frame, AI bats at ~3.3 RPO, 27% wicket chance
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AI_TIERS={
  // barMin/barMax = px/frame the power bar moves (higher = harder to time)
  // spin = % of deliveries bowled as spin (huge OUT zone for player)
  // W/D/S1/S2/S3/S4 = wicket/dot/1/2/3/4 probabilities; remainder = six
  5:{barMin:7.0,barMax:10.0,spin:0.78,W:0.03,D:0.06,S1:0.14,S2:0.15,S3:0.07,S4:0.26}, // India/Aus: RPO~21, W=3%
  4:{barMin:5.0,barMax:7.0, spin:0.60,W:0.06,D:0.12,S1:0.20,S2:0.14,S3:0.05,S4:0.22}, // Eng/Pak:  RPO~17, W=6%
  3:{barMin:3.0,barMax:5.0, spin:0.38,W:0.12,D:0.22,S1:0.28,S2:0.11,S3:0.03,S4:0.14}, // SA/NZ/WI: RPO~11, W=12%
  2:{barMin:1.6,barMax:3.0, spin:0.22,W:0.20,D:0.32,S1:0.28,S2:0.08,S3:0.02,S4:0.07}, // SL/Ban/Afg:RPO~6, W=20%
  1:{barMin:0.6,barMax:1.4, spin:0.08,W:0.30,D:0.40,S1:0.22,S2:0.04,S3:0.01,S4:0.02}, // Ire/Zim:  RPO~2.8,W=30%
};
function getAITier(){
  const r=selectedAITeam?selectedAITeam.rating:6;
  if(r<=2)return 5;if(r<=4)return 4;if(r<=7)return 3;if(r<=10)return 2;return 1;
}

function aiTakeTurn(){
  if(!IS_AI)return;
  // When AI is bowling: it already happened via aiBowl()
  // When AI is batting: schedule a hit after delay (harder AI hits more accurately)
  // aiTakeTurn is called when iAmBatting = player is batting = AI is bowling
  // So here we need to bowl
  if(iAmBatting()) setTimeout(aiBowl, 1200+Math.random()*800);
}

function aiBowl(){
  if(!IS_AI||!iAmBatting())return;
  const tier=AI_TIERS[getAITier()];
  // Bowl type: harder AI uses spin much more (bigger OUT zone for player)
  const type=Math.random()<tier.spin?'spin':'fast';
  // Speed: harder AI bowls MUCH faster ‚Üí player's bar moves faster ‚Üí harder to time
  // barMin/barMax are the TARGET bar speeds in px/frame
  // We need to reverse-engineer the bowl speed that produces that bar speed
  // startBar: spd = 1.1 + overBoost + (bowlSpeed/100)*3.8
  // So: bowlSpeed = (targetBarSpd - 1.1 - overBoost) / 3.8 * 100
  const overBoost=(GS.over/Math.max(1,GS.overs))*1.0;
  function barSpdToSpeed(targetSpd){
    return Math.max(0,Math.min(100,((targetSpd-1.1-overBoost)/3.8)*100));
  }
  const targetSpd=tier.barMin+Math.random()*(tier.barMax-tier.barMin);
  const speed=type==='spin'?0:barSpdToSpeed(targetSpd);
  receivedBowlType=type;
  onBowlReceived(speed,type);
}

function aiScheduleHit(){
  if(!IS_AI)return;
  const tier=getAITier();
  // Harder AI reacts nearly instantly, easy AI is slow and deliberate
  // Tier 5: 400-700ms, Tier 4: 600-1000ms, Tier 3: 900-1400ms, Tier 2: 1400-2000ms, Tier 1: 2000-3000ms
  const minDelay=[0,2000,1400,900,600,400][tier];
  const maxDelay=[0,3000,2000,1400,1000,700][tier];
  const delay=minDelay+Math.random()*(maxDelay-minDelay);
  setTimeout(()=>{
    if(!IS_AI)return;
    const result=aiCalcResult();
    animBall(currentBowlType||'fast');
    setTimeout(()=>applyHit(result,false),300);
  },delay);
}

function aiCalcResult(){
  // Uses tier-based probability tables ‚Äî HUGE difference between tiers
  // Very Hard (tier 5): W=5%, D=10%, 1=20%, 2=15%, 3=5%, 4=22%, 6=23% ‚Üí ~17 RPO
  // Very Easy (tier 1): W=27%, D=38%, 1=25%, 2=5%, 3=1%, 4=3%, 6=1% ‚Üí ~3 RPO
  const g=GS,bat=g.batting,s=g.scores[bat];
  const tier=AI_TIERS[getAITier()];
  const {W,D,S1,S2,S3,S4}=tier;

  let r=Math.random();

  // Chase adjustment ‚Äî harder AI chases better
  if(g.innings===2&&g.target!=null){
    const needed=g.target-s.r;
    const ballsLeft=Math.max(1,(g.overs-g.over)*6+(6-g.ball));
    const rr=needed/ballsLeft;
    if(rr>2.0){
      // Desperate chase ‚Äî go for big shots, accept risk
      let c=0;
      if(r<(c+=W*0.7))return'W';
      if(r<(c+=D*0.4))return 0;
      if(r<(c+=S1*0.6))return 1;
      if(r<(c+=S2))return 2;
      if(r<(c+=S4*1.2))return 4;
      return 6;
    }
    if(rr<0.6){
      // Comfortable ‚Äî rotate strike
      let c=0;
      if(r<(c+=W*0.5))return'W';
      if(r<(c+=D*1.5))return 0;
      if(r<(c+=S1*1.6))return 1;
      if(r<(c+=S2*1.3))return 2;
      return Math.random()<0.2?4:1;
    }
  }

  // Default: use tier probabilities
  let c=0;
  if(r<(c+=W))return'W';
  if(r<(c+=D))return 0;
  if(r<(c+=S1))return 1;
  if(r<(c+=S2))return 2;
  if(r<(c+=S3))return 3;
  if(r<(c+=S4))return 4;
  return 6;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(){goTo('gameScreen');refreshScoreboard();updateFieldChars();setupMyControls();}
function iAmBatting(){return GS.batting===myKey;}
function iAmBowling(){return GS.batting!==myKey;}

function setupMyControls(){
  document.getElementById('batterCtrl').style.display='none';
  document.getElementById('bowlerCtrl').style.display='none';
  document.getElementById('waitCtrl').style.display='none';
  stopSbar();
  const rb=document.getElementById('roleBadge');
  if(iAmBatting()){
    rb.className='role-badge bat';rb.textContent='üèè YOU ARE BATTING'+(IS_AI?' vs '+selectedAITeam.flag+' '+selectedAITeam.name:'');
    document.getElementById('batterCtrl').style.display='block';
    document.getElementById('pbarLbl').textContent='‚è≥ Waiting for opponent to bowl...';
    document.getElementById('hitBtn').disabled=true;
    document.getElementById('deliveryBadge').innerHTML='';
    stopBar();aiTakeTurn();
  }else{
    rb.className='role-badge bowl';rb.textContent='‚öæ YOU ARE BOWLING'+(IS_AI?' vs '+selectedAITeam.flag+' '+selectedAITeam.name:'');
    document.getElementById('bowlerCtrl').style.display='block';
    currentBowlType=null;
    document.getElementById('fastBar').style.display='none';
    document.getElementById('spinInfo').style.display='none';
    document.getElementById('bowlBtn').disabled=true;
    document.getElementById('btnFast').className='bowl-type-btn';
    document.getElementById('btnSpin').className='bowl-type-btn';
    stopSbar();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOWL TYPE SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectBowlType(type,el){
  currentBowlType=type;stopSbar();
  document.getElementById('btnFast').className='bowl-type-btn'+(type==='fast'?' sel-fast':'');
  document.getElementById('btnSpin').className='bowl-type-btn'+(type==='spin'?' sel-spin':'');
  if(type==='fast'){
    document.getElementById('fastBar').style.display='block';document.getElementById('spinInfo').style.display='none';
    sbarPos=0;sbarDir=1;document.getElementById('sbarFill').className='sbar-fill fast-mode';startSbar();
  }else{
    document.getElementById('fastBar').style.display='none';document.getElementById('spinInfo').style.display='block';
  }
  document.getElementById('bowlBtn').disabled=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOWLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bowlBall(){
  if(!currentBowlType)return;
  stopSbar();
  const speed=currentBowlType==='fast'?sbarPos:0;
  const bowlType=currentBowlType;
  document.getElementById('bowlBtn').disabled=true;
  animBall(bowlType);
  if(!IS_AI)send({type:'bowl',speed,bowlType});
  document.getElementById('bowlerCtrl').style.display='none';
  document.getElementById('waitCtrl').style.display='block';
  document.getElementById('waitTxt').textContent=IS_AI?('ü§ñ '+selectedAITeam.name+' IS DECIDING...'):'WAITING FOR OPPONENT TO HIT...';
  if(IS_AI)aiScheduleHit();
}

function onBowlReceived(speed,bowlType){
  receivedBowlType=bowlType||'fast';
  animBall(bowlType);
  setTimeout(()=>{
    const isSpinner=bowlType==='spin';
    const badge=isSpinner?'<span class="bowl-mode-badge spin">üåÄ SPIN DELIVERY ‚Äî MASSIVE OUT ZONE!</span>':`<span class="bowl-mode-badge fast">üî• ${speed>74?'FIREBOLT':speed>49?'FAST':speed>24?'MEDIUM':'SLOW'} DELIVERY</span>`;
    document.getElementById('deliveryBadge').innerHTML=badge;
    if(isSpinner){
      document.getElementById('pbarZonesFast').style.display='none';document.getElementById('pbarZonesSpin').style.display='flex';
      document.getElementById('pbarFill').className='pbar-fill spin-mode';
      document.getElementById('pbarLbl').textContent='üåÄ SPIN! Time your hit carefully ‚Äî OUT zone is huge!';
    }else{
      document.getElementById('pbarZonesFast').style.display='flex';document.getElementById('pbarZonesSpin').style.display='none';
      document.getElementById('pbarFill').className='pbar-fill';
      const spd=speed||50;
      document.getElementById('pbarLbl').textContent='‚ö° HIT NOW! '+(spd<25?'üê¢ SLOW':spd<50?'üéØ MEDIUM':spd<75?'‚ö° FAST':'üî• FIREBOLT')+' incoming!';
    }
    document.getElementById('hitBtn').disabled=false;
    startBar(speed,bowlType);
  },400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BATTING POWER BAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startBar(bowlSpeed,bowlType){
  barPos=0;barDir=1;barRunning=true;
  let spd;
  if(bowlType==='spin'){spd=0.55+(GS.over/(GS.overs||5))*0.3;}
  else{const overBoost=(GS.over/(GS.overs||5))*1.0,speedBoost=bowlSpeed!=null?(bowlSpeed/100)*3.8:1.5;spd=1.1+overBoost+speedBoost;}
  const fill=document.getElementById('pbarFill');
  barT=setInterval(()=>{barPos+=barDir*spd;if(barPos>=100){barPos=100;barDir=-1;}if(barPos<=0){barPos=0;barDir=1;}fill.style.width=barPos+'%';},16);
}
function stopBar(){barRunning=false;clearInterval(barT);const f=document.getElementById('pbarFill');if(f)f.style.width=barPos+'%';}

function startSbar(){
  sbarPos=0;sbarDir=1;sbarRunning=true;
  const fill=document.getElementById('sbarFill');
  sbarT=setInterval(()=>{sbarPos+=sbarDir*1.5;if(sbarPos>=100){sbarPos=100;sbarDir=-1;}if(sbarPos<=0){sbarPos=0;sbarDir=1;}fill.style.width=sbarPos+'%';},16);
}
function stopSbar(){sbarRunning=false;clearInterval(sbarT);const f=document.getElementById('sbarFill');if(f)f.style.width=sbarPos+'%';}

function hitBall(){
  if(!barRunning)return;
  stopBar();document.getElementById('hitBtn').disabled=true;
  const result=posToResult(barPos,receivedBowlType);
  animBall(receivedBowlType);
  if(!IS_AI)send({type:'hit',result});
  applyHit(result,true);
}

function posToResult(p,bowlType){
  if(bowlType==='spin'){
    if(p<10)return 0;if(p<17)return 1;if(p<24)return 4;if(p<31)return 6;return'W';
  }else{
    if(p<18)return 0;if(p<28)return 1;if(p<38)return 2;if(p<48)return 3;if(p<62)return 4;if(p<76)return 6;return'W';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELIVERY PROCESSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyHit(result,iHit){
  const g=GS,bat=g.batting;
  g.scores[bat].b++;g.ball++;
  let cls,txt,color;
  if(result==='W'){g.scores[bat].w++;cls='wk';txt='W';color='#e63946';showSplash('OUT!','DISMISSED!',color);wfx();}
  else if(result===0){cls='dot';txt='¬∑';color='#7a90b8';showSplash('¬∑','DOT BALL',color);}
  else{
    g.scores[bat].r+=result;
    if(result===4){g.scores[bat].f++;cls='r4';txt='4';color='#2dc653';showSplash('4!','BOUNDARY!',color);bpop();}
    else if(result===6){g.scores[bat].s++;cls='r6';txt='6';color='#f0c840';showSplash('6!','MAXIMUM!',color);fw(color);fw('#ff5500');}
    else{cls='r'+result;txt=String(result);color='#eef2ff';showSplash(String(result),result+' RUN'+(result>1?'S':'')+'!',color);}
  }
  g.overBalls.push({cls,txt});refreshScoreboard();
  if(g.innings===2&&g.target!=null&&g.scores[bat].r>=g.target){
    g.state='done';if(ROLE==='host'&&!IS_AI)send({type:'game_over',gs:g});setTimeout(showScorecard,800);return;
  }
  const isOut=result==='W',overDone=g.ball>=6;
  setTimeout(()=>{
    if(isOut||overDone){
      g.ball=0;g.overBalls=[];if(!isOut)g.over++;
      const innsOver=isOut||(g.over>=g.overs);
      if(innsOver){
        if(g.innings===1){
          g.innings=2;g.target=g.scores[bat].r+1;g.batting=bat==='p1'?'p2':'p1';g.over=0;g.ball=0;g.overBalls=[];g.state='break';
          if(ROLE==='host'&&!IS_AI)send({type:'innings_break',gs:g});
          showBreak();
        }else{g.state='done';if(ROLE==='host'&&!IS_AI)send({type:'game_over',gs:g});showScorecard();}
        return;
      }
    }
    updateFieldChars();refreshScoreboard();
    if(ROLE==='host'&&!IS_AI)send({type:'sync',gs:g});
    setupMyControls();
  },900);
}

function animBall(bowlType){
  const b=document.getElementById('gameBall');
  b.classList.remove('flying','spin-delivery','fast-delivery');
  if(bowlType==='spin'){
    b.classList.add('spin-delivery');b.style.transition='top .65s cubic-bezier(.4,.0,.2,1)';b.style.top='14%';
    setTimeout(()=>b.style.top='73%',150);setTimeout(()=>b.style.top='14%',700);setTimeout(()=>b.classList.remove('spin-delivery'),1400);
  }else{
    b.classList.add('fast-delivery');b.style.transition='top .30s cubic-bezier(.25,.8,.25,1)';b.style.top='14%';
    setTimeout(()=>b.style.top='73%',100);setTimeout(()=>b.style.top='14%',460);setTimeout(()=>b.classList.remove('fast-delivery'),700);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INNINGS BREAK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showBreak(){
  const g=GS,first=g.batting==='p1'?'p2':'p1';
  const c1=cbyid(GS.p1.country),c2=cbyid(GS.p2.country);
  document.getElementById('brkFlags').innerHTML=c1.flag+' ‚öîÔ∏è '+c2.flag;
  document.getElementById('brkSub').textContent=GS[first].name+' scored '+g.scores[first].r+'/'+g.scores[first].w;
  document.getElementById('brkTgt').textContent=g.target;
  document.getElementById('chaseLn').textContent=GS[g.batting].name+' needs '+g.target+' runs to win in '+g.overs+' overs';
  document.getElementById('breakStatus').innerHTML='';
  innings2HostReady=false;innings2GuestReady=false;
  goTo('breakScreen');
}
function readyForInnings2(){
  if(IS_AI){launchInnings2();return;}
  document.getElementById('breakStatus').innerHTML='<div class="status wait"><span class="dot"></span> Waiting for opponent...</div>';
  if(ROLE==='host'){innings2HostReady=true;send({type:'innings2_ready'});if(innings2GuestReady)launchInnings2();}
  else{innings2GuestReady=true;send({type:'innings2_ready'});}
}
function handleInnings2Ready(){
  if(ROLE==='host'){innings2GuestReady=true;if(innings2HostReady)launchInnings2();}
}
function launchInnings2(){GS.state='game';if(!IS_AI)send({type:'innings2_start',gs:GS});startInnings2();}
function startInnings2(){goTo('gameScreen');refreshScoreboard();updateFieldChars();setupMyControls();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCORECARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScorecard(){
  const g=GS,first=g.batting==='p1'?'p2':'p1',second=g.batting;
  const r1=g.scores[first].r,r2=g.scores[second].r;
  let wf,wn,res;
  if(g.target&&r2>=g.target){wf=cbyid(GS[second].country).flag;wn=GS[second].name+' WINS!';res='By '+(10-g.scores[second].w)+' wickets';}
  else if(r1>r2){wf=cbyid(GS[first].country).flag;wn=GS[first].name+' WINS!';res='By '+(r1-r2)+' runs';}
  else if(r2>r1){wf=cbyid(GS[second].country).flag;wn=GS[second].name+' WINS!';res='Chased down!';}
  else{wf='ü§ù';wn='TIE!';res='What a match!';}
  document.getElementById('scWF').textContent=wf;
  document.getElementById('scWN').textContent=wn;
  document.getElementById('scR').textContent=res;
  fillScTable('scB1','scT1',first,'1st Innings');
  fillScTable('scB2','scT2',second,'2nd Innings');
  rematchHostReady=false;rematchGuestReady=false;
  resetRematchUI();
  // Hide rematch vs AI
  const rmBtn=document.getElementById('rematchBtn');
  if(rmBtn)rmBtn.style.display=IS_AI?'none':'';
  fw('#f0c840');setTimeout(()=>fw('#ff4400'),500);
  goTo('scorecardScreen');
}

function fillScTable(bid,tid,pk,label){
  const s=GS.scores[pk],sr=s.b?((s.r/s.b)*100).toFixed(1):'0.0',c=cbyid(GS[pk].country);
  document.getElementById(tid).textContent=c.flag+' '+GS[pk].name+' ‚Äî '+label;
  document.getElementById(bid).innerHTML=`<tr><td>${c.flag} ${GS[pk].name}</td><td class="hi">${s.r}</td><td>${s.b}</td><td>${s.f}</td><td>${s.s}</td><td>${sr}</td></tr>`;
}

function playAgain(){
  stopCountdown();clearTimeout(searchTimer);
  const aib=document.getElementById('aiDiffBanner');if(aib)aib.remove();
  if(peer){try{peer.destroy();}catch(e){}peer=null;}
  conn=null;GS=null;ROLE=null;IS_AI=false;
  setConnDot('');
  document.getElementById('searchingCard').style.display='none';
  document.getElementById('findBtn').disabled=false;
  document.getElementById('matchStatus').innerHTML='';
  document.getElementById('shareBox').style.display='none';
  document.getElementById('createBtn').disabled=false;
  document.getElementById('hostStatus').innerHTML='';
  refreshHomeBadge();
  switchTab(MATCH_MODE);
  goTo('homeScreen');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REMATCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetRematchUI(){
  document.getElementById('rematchBtns').style.display='block';
  document.getElementById('rematchWait').style.display='none';
  document.getElementById('rematchIncoming').style.display='none';
}
function requestRematch(){
  document.getElementById('rematchBtns').style.display='none';
  document.getElementById('rematchWait').style.display='block';
  document.getElementById('rematchWaitTxt').textContent='Waiting for '+(ROLE==='host'?GS.p2.name:GS.p1.name)+' to accept...';
  send({type:'rematch_request'});
  if(ROLE==='host'&&rematchGuestReady){launchRematch();}
  else if(ROLE==='guest'&&rematchHostReady){send({type:'rematch_accept'});launchRematch();}
  else{if(ROLE==='host')rematchHostReady=true;else rematchGuestReady=true;}
}
function onRematchRequest(){
  if(ROLE==='host')rematchGuestReady=true;else rematchHostReady=true;
  if((ROLE==='host'&&rematchHostReady)||(ROLE==='guest'&&rematchGuestReady)){send({type:'rematch_accept'});launchRematch();return;}
  document.getElementById('rematchBtns').style.display='none';document.getElementById('rematchIncoming').style.display='block';
  document.getElementById('rematchIncomingTxt').textContent=(ROLE==='host'?GS.p2.name:GS.p1.name)+' wants a rematch!';
}
function acceptRematch(){send({type:'rematch_accept'});launchRematch();}
function onRematchAccepted(){launchRematch();}
function launchRematch(){
  rematchHostReady=false;rematchGuestReady=false;
  const prevP1=GS.p1,prevP2=GS.p2,prevOvers=GS.overs;
  GS={p1:prevP1,p2:prevP2,overs:prevOvers,innings:1,batting:'p1',over:0,ball:0,overBalls:[],target:null,scores:{p1:{r:0,w:0,b:0,f:0,s:0},p2:{r:0,w:0,b:0,f:0,s:0}},toss:{pick:null,result:null,winner:null,batting:null},state:'toss'};
  tossPick=null;
  if(ROLE==='host'){send({type:'start_toss',gs:GS});startToss('host');}
  else{startToss('guest');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshScoreboard(){
  if(!GS)return;const g=GS,p1=GS.p1,p2=GS.p2;if(!p1||!p2)return;
  const c1=cbyid(p1.country),c2=cbyid(p2.country);const isBatP1=g.batting==='p1';
  document.getElementById('sbF1').textContent=c1.flag;document.getElementById('sbN1').textContent=p1.name;
  document.getElementById('sbS1').textContent=isBatP1?g.scores.p1.r+'/'+g.scores.p1.w:(g.innings===1?'‚Äî':g.scores.p1.r+'/'+g.scores.p1.w);
  document.getElementById('sbS1').className='sb-sc '+(isBatP1?'bat':'fld');
  document.getElementById('sbF2').textContent=c2.flag;document.getElementById('sbN2').textContent=p2.name;
  document.getElementById('sbS2').textContent=!isBatP1?g.scores.p2.r+'/'+g.scores.p2.w:(g.innings===1?'‚Äî':g.scores.p2.r+'/'+g.scores.p2.w);
  document.getElementById('sbS2').className='sb-sc '+(!isBatP1?'bat':'fld');
  document.getElementById('sbInn').textContent=g.innings===1?'1ST':'2ND';
  document.getElementById('sbOvc').textContent=g.over+'.'+g.ball+' / '+g.overs+'.0';
  document.getElementById('sbTgt').textContent=g.target?'TARGET: '+g.target:'';
  updateOverChips(g.overBalls);
}

function updateOverChips(balls){
  const oc=document.getElementById('overChips');oc.innerHTML='';
  for(let i=0;i<6;i++){const d=document.createElement('div');if(balls&&i<balls.length){d.className='bc '+balls[i].cls;d.textContent=balls[i].txt;}else d.className='bc em';oc.appendChild(d);}
}

function updateFieldChars(){
  if(!GS||!GS.p1||!GS.p2)return;
  const bat=GS.batting,bowl=bat==='p1'?'p2':'p1';
  const bp=cbyid(GS[bat].country),bwp=cbyid(GS[bowl].country);
  document.getElementById('svgLeft').innerHTML=batSVG(bp);
  document.getElementById('cfLeft').textContent=bp.flag;document.getElementById('cnLeft').textContent=GS[bat].name;
  document.getElementById('crLeft').textContent='BATTING';document.getElementById('crLeft').className='char-role bat';
  document.getElementById('svgRight').innerHTML=bowlSVG(bwp);
  document.getElementById('cfRight').textContent=bwp.flag;document.getElementById('cnRight').textContent=GS[bowl].name;
  document.getElementById('crRight').textContent='BOWLING';document.getElementById('crRight').className='char-role bowl';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPLASH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showSplash(r,m,color){
  const el=document.getElementById('splash'),re=document.getElementById('spR');
  re.textContent=r;re.style.color=color;document.getElementById('spM').textContent=m;
  el.classList.add('on');setTimeout(()=>el.classList.remove('on'),900);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load',()=>{
  setTimeout(()=>{const s=document.getElementById('appSplash');if(s){s.classList.add('gone');setTimeout(()=>{s.style.display='none';},550);}},2000);
});
if('serviceWorker'in navigator){
  const swCode=`const CACHE='cricket-v1';self.addEventListener('install',e=>{self.skipWaiting();});self.addEventListener('activate',e=>{self.clients.claim();});self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(fetch(e.request).then(r=>{const c=r.clone();caches.open(CACHE).then(ca=>ca.put(e.request,c));return r;}).catch(()=>caches.match(e.request)));});`;
  try{const blob=new Blob([swCode],{type:'application/javascript'});navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});}catch(e){}
}
let _installPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();_installPrompt=e;if(!window.matchMedia('(display-mode:standalone)').matches)setTimeout(()=>document.getElementById('installBanner').classList.add('visible'),4000);});
window.addEventListener('appinstalled',()=>dismissBanner());
function doInstall(){dismissBanner();if(_installPrompt){_installPrompt.prompt();_installPrompt.userChoice.then(()=>{_installPrompt=null;});}}
function dismissBanner(){document.getElementById('installBanner').classList.remove('visible');}
(async()=>{if('wakeLock'in navigator){try{await navigator.wakeLock.request('screen');}catch(e){}}})();
</script>
</body>
</html>
